"use strict";
/*
 * ATTENTION: An "eval-source-map" devtool has been used.
 * This devtool is neither made for production nor for readable output files.
 * It uses "eval()" calls to create a separate source file with attached SourceMaps in the browser devtools.
 * If you are trying to read the output file, select a different devtool (https://webpack.js.org/configuration/devtool/)
 * or disable the default devtool with "devtool: false".
 * If you are looking for production-ready output files, see mode: "production" (https://webpack.js.org/configuration/mode/).
 */
(() => {
var exports = {};
exports.id = "app/api/chat/route";
exports.ids = ["app/api/chat/route"];
exports.modules = {

/***/ "next/dist/compiled/next-server/app-page.runtime.dev.js":
/*!*************************************************************************!*\
  !*** external "next/dist/compiled/next-server/app-page.runtime.dev.js" ***!
  \*************************************************************************/
/***/ ((module) => {

module.exports = require("next/dist/compiled/next-server/app-page.runtime.dev.js");

/***/ }),

/***/ "next/dist/compiled/next-server/app-route.runtime.dev.js":
/*!**************************************************************************!*\
  !*** external "next/dist/compiled/next-server/app-route.runtime.dev.js" ***!
  \**************************************************************************/
/***/ ((module) => {

module.exports = require("next/dist/compiled/next-server/app-route.runtime.dev.js");

/***/ }),

/***/ "buffer":
/*!*************************!*\
  !*** external "buffer" ***!
  \*************************/
/***/ ((module) => {

module.exports = require("buffer");

/***/ }),

/***/ "crypto":
/*!*************************!*\
  !*** external "crypto" ***!
  \*************************/
/***/ ((module) => {

module.exports = require("crypto");

/***/ }),

/***/ "events":
/*!*************************!*\
  !*** external "events" ***!
  \*************************/
/***/ ((module) => {

module.exports = require("events");

/***/ }),

/***/ "fs":
/*!*********************!*\
  !*** external "fs" ***!
  \*********************/
/***/ ((module) => {

module.exports = require("fs");

/***/ }),

/***/ "http":
/*!***********************!*\
  !*** external "http" ***!
  \***********************/
/***/ ((module) => {

module.exports = require("http");

/***/ }),

/***/ "https":
/*!************************!*\
  !*** external "https" ***!
  \************************/
/***/ ((module) => {

module.exports = require("https");

/***/ }),

/***/ "net":
/*!**********************!*\
  !*** external "net" ***!
  \**********************/
/***/ ((module) => {

module.exports = require("net");

/***/ }),

/***/ "path":
/*!***********************!*\
  !*** external "path" ***!
  \***********************/
/***/ ((module) => {

module.exports = require("path");

/***/ }),

/***/ "punycode":
/*!***************************!*\
  !*** external "punycode" ***!
  \***************************/
/***/ ((module) => {

module.exports = require("punycode");

/***/ }),

/***/ "stream":
/*!*************************!*\
  !*** external "stream" ***!
  \*************************/
/***/ ((module) => {

module.exports = require("stream");

/***/ }),

/***/ "tls":
/*!**********************!*\
  !*** external "tls" ***!
  \**********************/
/***/ ((module) => {

module.exports = require("tls");

/***/ }),

/***/ "url":
/*!**********************!*\
  !*** external "url" ***!
  \**********************/
/***/ ((module) => {

module.exports = require("url");

/***/ }),

/***/ "util":
/*!***********************!*\
  !*** external "util" ***!
  \***********************/
/***/ ((module) => {

module.exports = require("util");

/***/ }),

/***/ "worker_threads":
/*!*********************************!*\
  !*** external "worker_threads" ***!
  \*********************************/
/***/ ((module) => {

module.exports = require("worker_threads");

/***/ }),

/***/ "zlib":
/*!***********************!*\
  !*** external "zlib" ***!
  \***********************/
/***/ ((module) => {

module.exports = require("zlib");

/***/ }),

/***/ "node:fs":
/*!**************************!*\
  !*** external "node:fs" ***!
  \**************************/
/***/ ((module) => {

module.exports = require("node:fs");

/***/ }),

/***/ "node:stream":
/*!******************************!*\
  !*** external "node:stream" ***!
  \******************************/
/***/ ((module) => {

module.exports = require("node:stream");

/***/ }),

/***/ "node:stream/web":
/*!**********************************!*\
  !*** external "node:stream/web" ***!
  \**********************************/
/***/ ((module) => {

module.exports = require("node:stream/web");

/***/ }),

/***/ "(rsc)/./node_modules/next/dist/build/webpack/loaders/next-app-loader.js?name=app%2Fapi%2Fchat%2Froute&page=%2Fapi%2Fchat%2Froute&appPaths=&pagePath=private-next-app-dir%2Fapi%2Fchat%2Froute.ts&appDir=%2Fhome%2Fjr%2FProjetos%2FMestrAi%2Fapp&pageExtensions=tsx&pageExtensions=ts&pageExtensions=jsx&pageExtensions=js&rootDir=%2Fhome%2Fjr%2FProjetos%2FMestrAi&isDev=true&tsconfigPath=tsconfig.json&basePath=&assetPrefix=&nextConfigOutput=&preferredRegion=&middlewareConfig=e30%3D!":
/*!**********************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************!*\
  !*** ./node_modules/next/dist/build/webpack/loaders/next-app-loader.js?name=app%2Fapi%2Fchat%2Froute&page=%2Fapi%2Fchat%2Froute&appPaths=&pagePath=private-next-app-dir%2Fapi%2Fchat%2Froute.ts&appDir=%2Fhome%2Fjr%2FProjetos%2FMestrAi%2Fapp&pageExtensions=tsx&pageExtensions=ts&pageExtensions=jsx&pageExtensions=js&rootDir=%2Fhome%2Fjr%2FProjetos%2FMestrAi&isDev=true&tsconfigPath=tsconfig.json&basePath=&assetPrefix=&nextConfigOutput=&preferredRegion=&middlewareConfig=e30%3D! ***!
  \**********************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

eval("__webpack_require__.r(__webpack_exports__);\n/* harmony export */ __webpack_require__.d(__webpack_exports__, {\n/* harmony export */   originalPathname: () => (/* binding */ originalPathname),\n/* harmony export */   patchFetch: () => (/* binding */ patchFetch),\n/* harmony export */   requestAsyncStorage: () => (/* binding */ requestAsyncStorage),\n/* harmony export */   routeModule: () => (/* binding */ routeModule),\n/* harmony export */   serverHooks: () => (/* binding */ serverHooks),\n/* harmony export */   staticGenerationAsyncStorage: () => (/* binding */ staticGenerationAsyncStorage)\n/* harmony export */ });\n/* harmony import */ var next_dist_server_future_route_modules_app_route_module_compiled__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! next/dist/server/future/route-modules/app-route/module.compiled */ \"(rsc)/./node_modules/next/dist/server/future/route-modules/app-route/module.compiled.js\");\n/* harmony import */ var next_dist_server_future_route_modules_app_route_module_compiled__WEBPACK_IMPORTED_MODULE_0___default = /*#__PURE__*/__webpack_require__.n(next_dist_server_future_route_modules_app_route_module_compiled__WEBPACK_IMPORTED_MODULE_0__);\n/* harmony import */ var next_dist_server_future_route_kind__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! next/dist/server/future/route-kind */ \"(rsc)/./node_modules/next/dist/server/future/route-kind.js\");\n/* harmony import */ var next_dist_server_lib_patch_fetch__WEBPACK_IMPORTED_MODULE_2__ = __webpack_require__(/*! next/dist/server/lib/patch-fetch */ \"(rsc)/./node_modules/next/dist/server/lib/patch-fetch.js\");\n/* harmony import */ var next_dist_server_lib_patch_fetch__WEBPACK_IMPORTED_MODULE_2___default = /*#__PURE__*/__webpack_require__.n(next_dist_server_lib_patch_fetch__WEBPACK_IMPORTED_MODULE_2__);\n/* harmony import */ var _home_jr_Projetos_MestrAi_app_api_chat_route_ts__WEBPACK_IMPORTED_MODULE_3__ = __webpack_require__(/*! ./app/api/chat/route.ts */ \"(rsc)/./app/api/chat/route.ts\");\n\n\n\n\n// We inject the nextConfigOutput here so that we can use them in the route\n// module.\nconst nextConfigOutput = \"\"\nconst routeModule = new next_dist_server_future_route_modules_app_route_module_compiled__WEBPACK_IMPORTED_MODULE_0__.AppRouteRouteModule({\n    definition: {\n        kind: next_dist_server_future_route_kind__WEBPACK_IMPORTED_MODULE_1__.RouteKind.APP_ROUTE,\n        page: \"/api/chat/route\",\n        pathname: \"/api/chat\",\n        filename: \"route\",\n        bundlePath: \"app/api/chat/route\"\n    },\n    resolvedPagePath: \"/home/jr/Projetos/MestrAi/app/api/chat/route.ts\",\n    nextConfigOutput,\n    userland: _home_jr_Projetos_MestrAi_app_api_chat_route_ts__WEBPACK_IMPORTED_MODULE_3__\n});\n// Pull out the exports that we need to expose from the module. This should\n// be eliminated when we've moved the other routes to the new format. These\n// are used to hook into the route.\nconst { requestAsyncStorage, staticGenerationAsyncStorage, serverHooks } = routeModule;\nconst originalPathname = \"/api/chat/route\";\nfunction patchFetch() {\n    return (0,next_dist_server_lib_patch_fetch__WEBPACK_IMPORTED_MODULE_2__.patchFetch)({\n        serverHooks,\n        staticGenerationAsyncStorage\n    });\n}\n\n\n//# sourceMappingURL=app-route.js.map//# sourceURL=[module]\n//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiKHJzYykvLi9ub2RlX21vZHVsZXMvbmV4dC9kaXN0L2J1aWxkL3dlYnBhY2svbG9hZGVycy9uZXh0LWFwcC1sb2FkZXIuanM/bmFtZT1hcHAlMkZhcGklMkZjaGF0JTJGcm91dGUmcGFnZT0lMkZhcGklMkZjaGF0JTJGcm91dGUmYXBwUGF0aHM9JnBhZ2VQYXRoPXByaXZhdGUtbmV4dC1hcHAtZGlyJTJGYXBpJTJGY2hhdCUyRnJvdXRlLnRzJmFwcERpcj0lMkZob21lJTJGanIlMkZQcm9qZXRvcyUyRk1lc3RyQWklMkZhcHAmcGFnZUV4dGVuc2lvbnM9dHN4JnBhZ2VFeHRlbnNpb25zPXRzJnBhZ2VFeHRlbnNpb25zPWpzeCZwYWdlRXh0ZW5zaW9ucz1qcyZyb290RGlyPSUyRmhvbWUlMkZqciUyRlByb2pldG9zJTJGTWVzdHJBaSZpc0Rldj10cnVlJnRzY29uZmlnUGF0aD10c2NvbmZpZy5qc29uJmJhc2VQYXRoPSZhc3NldFByZWZpeD0mbmV4dENvbmZpZ091dHB1dD0mcHJlZmVycmVkUmVnaW9uPSZtaWRkbGV3YXJlQ29uZmlnPWUzMCUzRCEiLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7O0FBQXNHO0FBQ3ZDO0FBQ2M7QUFDRDtBQUM1RTtBQUNBO0FBQ0E7QUFDQSx3QkFBd0IsZ0hBQW1CO0FBQzNDO0FBQ0EsY0FBYyx5RUFBUztBQUN2QjtBQUNBO0FBQ0E7QUFDQTtBQUNBLEtBQUs7QUFDTDtBQUNBO0FBQ0EsWUFBWTtBQUNaLENBQUM7QUFDRDtBQUNBO0FBQ0E7QUFDQSxRQUFRLGlFQUFpRTtBQUN6RTtBQUNBO0FBQ0EsV0FBVyw0RUFBVztBQUN0QjtBQUNBO0FBQ0EsS0FBSztBQUNMO0FBQ3VIOztBQUV2SCIsInNvdXJjZXMiOlsid2VicGFjazovL21lc3RyYWktLS12aXJ0dWFsLXRhYmxldG9wLz83ZmNlIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEFwcFJvdXRlUm91dGVNb2R1bGUgfSBmcm9tIFwibmV4dC9kaXN0L3NlcnZlci9mdXR1cmUvcm91dGUtbW9kdWxlcy9hcHAtcm91dGUvbW9kdWxlLmNvbXBpbGVkXCI7XG5pbXBvcnQgeyBSb3V0ZUtpbmQgfSBmcm9tIFwibmV4dC9kaXN0L3NlcnZlci9mdXR1cmUvcm91dGUta2luZFwiO1xuaW1wb3J0IHsgcGF0Y2hGZXRjaCBhcyBfcGF0Y2hGZXRjaCB9IGZyb20gXCJuZXh0L2Rpc3Qvc2VydmVyL2xpYi9wYXRjaC1mZXRjaFwiO1xuaW1wb3J0ICogYXMgdXNlcmxhbmQgZnJvbSBcIi9ob21lL2pyL1Byb2pldG9zL01lc3RyQWkvYXBwL2FwaS9jaGF0L3JvdXRlLnRzXCI7XG4vLyBXZSBpbmplY3QgdGhlIG5leHRDb25maWdPdXRwdXQgaGVyZSBzbyB0aGF0IHdlIGNhbiB1c2UgdGhlbSBpbiB0aGUgcm91dGVcbi8vIG1vZHVsZS5cbmNvbnN0IG5leHRDb25maWdPdXRwdXQgPSBcIlwiXG5jb25zdCByb3V0ZU1vZHVsZSA9IG5ldyBBcHBSb3V0ZVJvdXRlTW9kdWxlKHtcbiAgICBkZWZpbml0aW9uOiB7XG4gICAgICAgIGtpbmQ6IFJvdXRlS2luZC5BUFBfUk9VVEUsXG4gICAgICAgIHBhZ2U6IFwiL2FwaS9jaGF0L3JvdXRlXCIsXG4gICAgICAgIHBhdGhuYW1lOiBcIi9hcGkvY2hhdFwiLFxuICAgICAgICBmaWxlbmFtZTogXCJyb3V0ZVwiLFxuICAgICAgICBidW5kbGVQYXRoOiBcImFwcC9hcGkvY2hhdC9yb3V0ZVwiXG4gICAgfSxcbiAgICByZXNvbHZlZFBhZ2VQYXRoOiBcIi9ob21lL2pyL1Byb2pldG9zL01lc3RyQWkvYXBwL2FwaS9jaGF0L3JvdXRlLnRzXCIsXG4gICAgbmV4dENvbmZpZ091dHB1dCxcbiAgICB1c2VybGFuZFxufSk7XG4vLyBQdWxsIG91dCB0aGUgZXhwb3J0cyB0aGF0IHdlIG5lZWQgdG8gZXhwb3NlIGZyb20gdGhlIG1vZHVsZS4gVGhpcyBzaG91bGRcbi8vIGJlIGVsaW1pbmF0ZWQgd2hlbiB3ZSd2ZSBtb3ZlZCB0aGUgb3RoZXIgcm91dGVzIHRvIHRoZSBuZXcgZm9ybWF0LiBUaGVzZVxuLy8gYXJlIHVzZWQgdG8gaG9vayBpbnRvIHRoZSByb3V0ZS5cbmNvbnN0IHsgcmVxdWVzdEFzeW5jU3RvcmFnZSwgc3RhdGljR2VuZXJhdGlvbkFzeW5jU3RvcmFnZSwgc2VydmVySG9va3MgfSA9IHJvdXRlTW9kdWxlO1xuY29uc3Qgb3JpZ2luYWxQYXRobmFtZSA9IFwiL2FwaS9jaGF0L3JvdXRlXCI7XG5mdW5jdGlvbiBwYXRjaEZldGNoKCkge1xuICAgIHJldHVybiBfcGF0Y2hGZXRjaCh7XG4gICAgICAgIHNlcnZlckhvb2tzLFxuICAgICAgICBzdGF0aWNHZW5lcmF0aW9uQXN5bmNTdG9yYWdlXG4gICAgfSk7XG59XG5leHBvcnQgeyByb3V0ZU1vZHVsZSwgcmVxdWVzdEFzeW5jU3RvcmFnZSwgc3RhdGljR2VuZXJhdGlvbkFzeW5jU3RvcmFnZSwgc2VydmVySG9va3MsIG9yaWdpbmFsUGF0aG5hbWUsIHBhdGNoRmV0Y2gsICB9O1xuXG4vLyMgc291cmNlTWFwcGluZ1VSTD1hcHAtcm91dGUuanMubWFwIl0sIm5hbWVzIjpbXSwic291cmNlUm9vdCI6IiJ9\n//# sourceURL=webpack-internal:///(rsc)/./node_modules/next/dist/build/webpack/loaders/next-app-loader.js?name=app%2Fapi%2Fchat%2Froute&page=%2Fapi%2Fchat%2Froute&appPaths=&pagePath=private-next-app-dir%2Fapi%2Fchat%2Froute.ts&appDir=%2Fhome%2Fjr%2FProjetos%2FMestrAi%2Fapp&pageExtensions=tsx&pageExtensions=ts&pageExtensions=jsx&pageExtensions=js&rootDir=%2Fhome%2Fjr%2FProjetos%2FMestrAi&isDev=true&tsconfigPath=tsconfig.json&basePath=&assetPrefix=&nextConfigOutput=&preferredRegion=&middlewareConfig=e30%3D!\n");

/***/ }),

/***/ "(rsc)/./app/api/chat/route.ts":
/*!*******************************!*\
  !*** ./app/api/chat/route.ts ***!
  \*******************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

eval("__webpack_require__.r(__webpack_exports__);\n/* harmony export */ __webpack_require__.d(__webpack_exports__, {\n/* harmony export */   POST: () => (/* binding */ POST)\n/* harmony export */ });\n/* harmony import */ var next_server__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! next/server */ \"(rsc)/./node_modules/next/dist/api/server.js\");\n/* harmony import */ var groq_sdk__WEBPACK_IMPORTED_MODULE_8__ = __webpack_require__(/*! groq-sdk */ \"(rsc)/./node_modules/groq-sdk/index.mjs\");\n/* harmony import */ var zod__WEBPACK_IMPORTED_MODULE_7__ = __webpack_require__(/*! zod */ \"(rsc)/./node_modules/zod/v3/types.js\");\n/* harmony import */ var _lib_ai_keyPool__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! ../../../lib/ai/keyPool */ \"(rsc)/./lib/ai/keyPool.ts\");\n/* harmony import */ var _lib_ai_systemPrompt__WEBPACK_IMPORTED_MODULE_2__ = __webpack_require__(/*! ../../../lib/ai/systemPrompt */ \"(rsc)/./lib/ai/systemPrompt.ts\");\n/* harmony import */ var _lib_ai_rateLimit__WEBPACK_IMPORTED_MODULE_3__ = __webpack_require__(/*! ../../../lib/ai/rateLimit */ \"(rsc)/./lib/ai/rateLimit.ts\");\n/* harmony import */ var _lib_ai_modelPool__WEBPACK_IMPORTED_MODULE_4__ = __webpack_require__(/*! ../../../lib/ai/modelPool */ \"(rsc)/./lib/ai/modelPool.ts\");\n/* harmony import */ var _types__WEBPACK_IMPORTED_MODULE_5__ = __webpack_require__(/*! ../../../types */ \"(rsc)/./types.ts\");\n/* harmony import */ var _lib_supabase_server__WEBPACK_IMPORTED_MODULE_6__ = __webpack_require__(/*! ../../../lib/supabase/server */ \"(rsc)/./lib/supabase/server.ts\");\n\n\n\n\n\n\n\n\n\n// shared rate limiter in lib/ai/rateLimit\nconst STREAMING_ENABLED = false;\nconst requestRollSchema = {\n    type: \"object\",\n    properties: {\n        attribute: {\n            type: \"string\"\n        },\n        difficulty_class: {\n            type: \"number\"\n        },\n        description: {\n            type: \"string\"\n        }\n    },\n    required: [\n        \"attribute\",\n        \"difficulty_class\",\n        \"description\"\n    ]\n};\nconst generateImageSchema = {\n    type: \"object\",\n    properties: {\n        prompt: {\n            type: \"string\"\n        }\n    },\n    required: [\n        \"prompt\"\n    ]\n};\nconst triggerGameOverSchema = {\n    type: \"object\",\n    properties: {\n        causeOfDeath: {\n            type: \"string\"\n        },\n        worldFuture: {\n            type: \"string\"\n        }\n    },\n    required: [\n        \"causeOfDeath\",\n        \"worldFuture\"\n    ]\n};\nconst updateCharacterSchema = {\n    type: \"object\",\n    properties: {\n        profession: {\n            type: \"string\"\n        },\n        hp: {\n            type: \"number\"\n        },\n        inventory: {\n            type: \"array\",\n            items: {\n                type: \"string\"\n            }\n        }\n    },\n    required: []\n};\nfunction safeParseArgs(args) {\n    if (!args) return {};\n    if (typeof args === \"object\") return args;\n    if (typeof args === \"string\") {\n        try {\n            return JSON.parse(args);\n        } catch  {\n            return {};\n        }\n    }\n    return {};\n}\nfunction normalizeToolCalls(rawCalls) {\n    const calls = Array.isArray(rawCalls) ? rawCalls : [];\n    return calls.map((call)=>({\n            id: call?.id,\n            name: call?.function?.name || call?.name,\n            args: safeParseArgs(call?.function?.arguments ?? call?.args)\n        }));\n}\nfunction extractRetryAfterSeconds(error) {\n    if (!error) return null;\n    const headerVal = error?.response?.headers?.[\"retry-after\"] || error?.response?.headers?.get?.(\"retry-after\") || error?.headers?.[\"retry-after\"];\n    if (typeof headerVal === \"string\") {\n        const parsed = Number(headerVal);\n        if (Number.isFinite(parsed)) return parsed;\n    }\n    const details = error?.details || error?.error?.details;\n    if (Array.isArray(details)) {\n        const retry = details.find((d)=>String(d?.[\"@type\"] || \"\").includes(\"RetryInfo\"));\n        const delay = retry?.retryDelay || retry?.[\"retryDelay\"];\n        if (typeof delay === \"string\") {\n            const match = delay.match(/(\\d+)s/);\n            if (match) return Number(match[1]);\n        }\n    }\n    const msg = typeof error?.message === \"string\" ? error.message : \"\";\n    const msgMatch = msg.match(/\"retryDelay\"\\s*:\\s*\"(\\d+)s\"/);\n    if (msgMatch) return Number(msgMatch[1]);\n    return null;\n}\nconst bodySchema = zod__WEBPACK_IMPORTED_MODULE_7__.object({\n    campaign: zod__WEBPACK_IMPORTED_MODULE_7__.custom(),\n    messages: zod__WEBPACK_IMPORTED_MODULE_7__.array(zod__WEBPACK_IMPORTED_MODULE_7__.custom()),\n    input: zod__WEBPACK_IMPORTED_MODULE_7__.string().optional(),\n    toolResponse: zod__WEBPACK_IMPORTED_MODULE_7__.object({\n        name: zod__WEBPACK_IMPORTED_MODULE_7__.string(),\n        result: zod__WEBPACK_IMPORTED_MODULE_7__.any(),\n        callId: zod__WEBPACK_IMPORTED_MODULE_7__.string().optional(),\n        args: zod__WEBPACK_IMPORTED_MODULE_7__.record(zod__WEBPACK_IMPORTED_MODULE_7__.any()).optional()\n    }).optional()\n});\nfunction mapRole(role) {\n    if (role === _types__WEBPACK_IMPORTED_MODULE_5__.Role.USER) return \"user\";\n    if (role === _types__WEBPACK_IMPORTED_MODULE_5__.Role.MODEL) return \"assistant\";\n    return \"system\";\n}\nasync function POST(req) {\n    try {\n        const json = await req.json();\n        const parsed = bodySchema.safeParse(json);\n        if (!parsed.success) {\n            return next_server__WEBPACK_IMPORTED_MODULE_0__.NextResponse.json({\n                error: \"Invalid payload\"\n            }, {\n                status: 400\n            });\n        }\n        const { campaign, messages, input, toolResponse } = parsed.data;\n        const userKey = req.headers.get(\"x-custom-api-key\") || undefined;\n        let apiKey;\n        try {\n            apiKey = (0,_lib_ai_keyPool__WEBPACK_IMPORTED_MODULE_1__.pickApiKey)(userKey);\n        } catch  {\n            return next_server__WEBPACK_IMPORTED_MODULE_0__.NextResponse.json({\n                error: \"Missing API key\"\n            }, {\n                status: 401\n            });\n        }\n        const ai = new groq_sdk__WEBPACK_IMPORTED_MODULE_8__[\"default\"]({\n            apiKey\n        });\n        const authHeader = req.headers.get(\"authorization\") || \"\";\n        const token = authHeader.startsWith(\"Bearer \") ? authHeader.slice(7) : \"\";\n        if (!token) {\n            return next_server__WEBPACK_IMPORTED_MODULE_0__.NextResponse.json({\n                error: \"Missing auth token\"\n            }, {\n                status: 401\n            });\n        }\n        const sb = (0,_lib_supabase_server__WEBPACK_IMPORTED_MODULE_6__.createServerClient)(token);\n        const { data: userData } = await sb.auth.getUser(token);\n        if (!userData.user?.id) {\n            return next_server__WEBPACK_IMPORTED_MODULE_0__.NextResponse.json({\n                error: \"Unauthorized\"\n            }, {\n                status: 401\n            });\n        }\n        const rateKey = `chat:${userData.user.id}:${campaign.id}`;\n        if (await (0,_lib_ai_rateLimit__WEBPACK_IMPORTED_MODULE_3__.isRateLimited)(rateKey)) {\n            return next_server__WEBPACK_IMPORTED_MODULE_0__.NextResponse.json({\n                error: \"Rate limit exceeded\"\n            }, {\n                status: 429\n            });\n        }\n        const { data: campaignRow } = await sb.from(\"campaigns\").select(\"status, owner_id\").eq(\"id\", campaign.id).maybeSingle();\n        const { data: membership } = await sb.from(\"campaign_players\").select(\"status,is_dead,character_data_json\").eq(\"campaign_id\", campaign.id).eq(\"player_id\", userData.user.id).maybeSingle();\n        if (!membership && campaignRow?.owner_id !== userData.user.id) {\n            return next_server__WEBPACK_IMPORTED_MODULE_0__.NextResponse.json({\n                error: \"Forbidden\"\n            }, {\n                status: 403\n            });\n        }\n        if (membership?.is_dead) {\n            return next_server__WEBPACK_IMPORTED_MODULE_0__.NextResponse.json({\n                error: \"Character is dead\"\n            }, {\n                status: 403\n            });\n        }\n        if (!campaignRow) {\n            return next_server__WEBPACK_IMPORTED_MODULE_0__.NextResponse.json({\n                error: \"Campaign not found\"\n            }, {\n                status: 404\n            });\n        }\n        const effectiveStatus = campaignRow.status || campaign.status;\n        if (effectiveStatus === \"waiting_for_players\" || effectiveStatus === \"paused\") {\n            return next_server__WEBPACK_IMPORTED_MODULE_0__.NextResponse.json({\n                text: \"[SISTEMA] Mesa em espera.\",\n                toolCalls: []\n            });\n        }\n        const system = (0,_lib_ai_systemPrompt__WEBPACK_IMPORTED_MODULE_2__.buildSystemPrompt)(campaign);\n        const history = messages.filter((m)=>m.role !== _types__WEBPACK_IMPORTED_MODULE_5__.Role.SYSTEM).map((m)=>({\n                role: m.role === _types__WEBPACK_IMPORTED_MODULE_5__.Role.USER ? \"user\" : \"assistant\",\n                content: m.content || \"\"\n            }));\n        const tools = [\n            {\n                type: \"function\",\n                function: {\n                    name: \"request_roll\",\n                    description: \"Request a dice roll from the player.\",\n                    parameters: requestRollSchema\n                }\n            },\n            {\n                type: \"function\",\n                function: {\n                    name: \"generate_image\",\n                    description: \"Generate an image prompt for the story.\",\n                    parameters: generateImageSchema\n                }\n            },\n            {\n                type: \"function\",\n                function: {\n                    name: \"trigger_game_over\",\n                    description: \"Trigger a game over when the player dies.\",\n                    parameters: triggerGameOverSchema\n                }\n            },\n            {\n                type: \"function\",\n                function: {\n                    name: \"update_character\",\n                    description: \"Update character fields like profession, hp, or inventory when the story changes.\",\n                    parameters: updateCharacterSchema\n                }\n            }\n        ];\n        const baseMessages = [\n            {\n                role: \"system\",\n                content: system\n            },\n            ...history\n        ];\n        const buildMessages = ()=>{\n            if (toolResponse) {\n                const toolCallId = toolResponse.callId || `call_${toolResponse.name}`;\n                const toolArgs = toolResponse.args || {};\n                return [\n                    ...baseMessages,\n                    {\n                        role: \"assistant\",\n                        content: \"\",\n                        tool_calls: [\n                            {\n                                id: toolCallId,\n                                type: \"function\",\n                                function: {\n                                    name: toolResponse.name,\n                                    arguments: JSON.stringify(toolArgs)\n                                }\n                            }\n                        ]\n                    },\n                    {\n                        role: \"tool\",\n                        tool_call_id: toolCallId,\n                        content: JSON.stringify(toolResponse.result ?? \"\")\n                    }\n                ];\n            }\n            if (input && input.trim().length > 0) {\n                return [\n                    ...baseMessages,\n                    {\n                        role: \"user\",\n                        content: input\n                    }\n                ];\n            }\n            return baseMessages;\n        };\n        const wantsStream = req.headers.get(\"accept\")?.includes(\"text/event-stream\") || req.headers.get(\"x-stream\") === \"1\";\n        if (wantsStream && STREAMING_ENABLED) {\n            let streamResult;\n            try {\n                streamResult = await (0,_lib_ai_modelPool__WEBPACK_IMPORTED_MODULE_4__.withModelFallback)((model)=>ai.chat.completions.create({\n                        model,\n                        messages: buildMessages(),\n                        tools,\n                        tool_choice: \"auto\",\n                        temperature: 0.8,\n                        stream: true\n                    }), {\n                    key: `chat:${campaign.id}`\n                });\n            } catch (err) {\n                const status = err?.status || err?.code || 500;\n                if (status === 429) {\n                    const retryAfter = extractRetryAfterSeconds(err);\n                    return next_server__WEBPACK_IMPORTED_MODULE_0__.NextResponse.json({\n                        error: \"Rate limit exceeded\",\n                        retryAfter\n                    }, {\n                        status: 429,\n                        headers: retryAfter ? {\n                            \"Retry-After\": String(retryAfter)\n                        } : undefined\n                    });\n                }\n                return next_server__WEBPACK_IMPORTED_MODULE_0__.NextResponse.json({\n                    error: \"Server error\"\n                }, {\n                    status: 500\n                });\n            }\n            const encoder = new TextEncoder();\n            const stream = new ReadableStream({\n                async start (controller) {\n                    let fullText = \"\";\n                    const toolCallMap = new Map();\n                    try {\n                        for await (const chunk of streamResult){\n                            const delta = chunk?.choices?.[0]?.delta || {};\n                            const textChunk = delta?.content || \"\";\n                            const deltaToolCalls = Array.isArray(delta?.tool_calls) ? delta.tool_calls : [];\n                            for (const call of deltaToolCalls){\n                                const callId = call?.id || `call_${call?.function?.name || call?.index || \"tool\"}`;\n                                const existing = toolCallMap.get(callId) || {\n                                    id: callId,\n                                    name: call?.function?.name,\n                                    argsText: \"\"\n                                };\n                                if (call?.function?.name) {\n                                    existing.name = call.function.name;\n                                }\n                                if (call?.function?.arguments) {\n                                    existing.argsText += call.function.arguments;\n                                }\n                                toolCallMap.set(callId, existing);\n                            }\n                            if (textChunk) {\n                                fullText += textChunk;\n                                controller.enqueue(encoder.encode(`data: ${JSON.stringify({\n                                    type: \"token\",\n                                    value: textChunk\n                                })}\\n\\n`));\n                            }\n                        }\n                        const toolCalls = Array.from(toolCallMap.values()).map((call)=>({\n                                id: call.id,\n                                name: call.name,\n                                args: safeParseArgs(call.argsText)\n                            }));\n                        controller.enqueue(encoder.encode(`data: ${JSON.stringify({\n                            type: \"done\",\n                            text: fullText || \"\",\n                            toolCalls\n                        })}\\n\\n`));\n                    } catch (err) {\n                        controller.enqueue(encoder.encode(`data: ${JSON.stringify({\n                            type: \"error\",\n                            message: \"stream_error\"\n                        })}\\n\\n`));\n                    } finally{\n                        controller.close();\n                    }\n                }\n            });\n            return new Response(stream, {\n                headers: {\n                    \"Content-Type\": \"text/event-stream; charset=utf-8\",\n                    \"Cache-Control\": \"no-cache, no-transform\",\n                    Connection: \"keep-alive\"\n                }\n            });\n        }\n        const response = await (0,_lib_ai_modelPool__WEBPACK_IMPORTED_MODULE_4__.withModelFallback)((model)=>ai.chat.completions.create({\n                model,\n                messages: buildMessages(),\n                tools,\n                tool_choice: \"auto\",\n                temperature: 0.8\n            }), {\n            key: `chat:${campaign.id}`\n        });\n        const message = response.choices?.[0]?.message;\n        const text = message?.content || \"\";\n        const toolCalls = normalizeToolCalls(message?.tool_calls);\n        return next_server__WEBPACK_IMPORTED_MODULE_0__.NextResponse.json({\n            text: text || \"\",\n            toolCalls\n        });\n    } catch (error) {\n        const status = error?.status || error?.code || 500;\n        console.error(\"Chat API error:\", error);\n        if (status === 429) {\n            const retryAfter = extractRetryAfterSeconds(error);\n            return next_server__WEBPACK_IMPORTED_MODULE_0__.NextResponse.json({\n                error: \"Rate limit exceeded\",\n                retryAfter\n            }, {\n                status: 429,\n                headers: retryAfter ? {\n                    \"Retry-After\": String(retryAfter)\n                } : undefined\n            });\n        }\n        return next_server__WEBPACK_IMPORTED_MODULE_0__.NextResponse.json({\n            error: \"Server error\"\n        }, {\n            status: 500\n        });\n    }\n}\n//# sourceURL=[module]\n//# sourceMappingURL=data:application/json;charset=utf-8;base64,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QUFNdUIsVUFBVWhCLFNBQVM0RyxPQUFPLEVBQUUsQ0FBQyxFQUFFLEVBQUU1RjtRQUN2QyxNQUFNa0QsT0FBT2xELFNBQVN5RCxXQUFXO1FBQ2pDLE1BQU1OLFlBQVlqRixtQkFBbUI4QixTQUFTZ0U7UUFFOUMsT0FBTzdILHFEQUFZQSxDQUFDbUYsSUFBSSxDQUFDO1lBQ3ZCNEIsTUFBTUEsUUFBUTtZQUNkQztRQUNGO0lBQ0YsRUFBRSxPQUFPckUsT0FBWTtRQUNuQixNQUFNMkMsU0FBUzNDLE9BQU8yQyxVQUFVM0MsT0FBT2tHLFFBQVE7UUFDL0MwQixRQUFRNUgsS0FBSyxDQUFDLG1CQUFtQkE7UUFDakMsSUFBSTJDLFdBQVcsS0FBSztZQUNsQixNQUFNd0QsYUFBYXBHLHlCQUF5QkM7WUFDNUMsT0FBTzNDLHFEQUFZQSxDQUFDbUYsSUFBSSxDQUN0QjtnQkFBRXhDLE9BQU87Z0JBQXVCbUc7WUFBVyxHQUMzQztnQkFBRXhELFFBQVE7Z0JBQUt4QyxTQUFTZ0csYUFBYTtvQkFBRSxlQUFldkYsT0FBT3VGO2dCQUFZLElBQUlyRDtZQUFVO1FBRTNGO1FBQ0EsT0FBT3pGLHFEQUFZQSxDQUFDbUYsSUFBSSxDQUFDO1lBQUV4QyxPQUFPO1FBQWUsR0FBRztZQUFFMkMsUUFBUTtRQUFJO0lBQ3BFO0FBQ0YiLCJzb3VyY2VzIjpbIndlYnBhY2s6Ly9tZXN0cmFpLS0tdmlydHVhbC10YWJsZXRvcC8uL2FwcC9hcGkvY2hhdC9yb3V0ZS50cz9kZTQ2Il0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IE5leHRSZXNwb25zZSB9IGZyb20gJ25leHQvc2VydmVyJztcbmltcG9ydCBHcm9xIGZyb20gJ2dyb3Etc2RrJztcbmltcG9ydCB7IHogfSBmcm9tICd6b2QnO1xuaW1wb3J0IHsgcGlja0FwaUtleSB9IGZyb20gJy4uLy4uLy4uL2xpYi9haS9rZXlQb29sJztcbmltcG9ydCB7IGJ1aWxkU3lzdGVtUHJvbXB0IH0gZnJvbSAnLi4vLi4vLi4vbGliL2FpL3N5c3RlbVByb21wdCc7XG5pbXBvcnQgeyBpc1JhdGVMaW1pdGVkIH0gZnJvbSAnLi4vLi4vLi4vbGliL2FpL3JhdGVMaW1pdCc7XG5pbXBvcnQgeyB3aXRoTW9kZWxGYWxsYmFjayB9IGZyb20gJy4uLy4uLy4uL2xpYi9haS9tb2RlbFBvb2wnO1xuaW1wb3J0IHsgQ2FtcGFpZ24sIE1lc3NhZ2UsIFJvbGUgfSBmcm9tICcuLi8uLi8uLi90eXBlcyc7XG5pbXBvcnQgeyBjcmVhdGVTZXJ2ZXJDbGllbnQgfSBmcm9tICcuLi8uLi8uLi9saWIvc3VwYWJhc2Uvc2VydmVyJztcblxuLy8gc2hhcmVkIHJhdGUgbGltaXRlciBpbiBsaWIvYWkvcmF0ZUxpbWl0XG5jb25zdCBTVFJFQU1JTkdfRU5BQkxFRCA9IGZhbHNlO1xuXG5jb25zdCByZXF1ZXN0Um9sbFNjaGVtYSA9IHtcbiAgdHlwZTogJ29iamVjdCcsXG4gIHByb3BlcnRpZXM6IHtcbiAgICBhdHRyaWJ1dGU6IHsgdHlwZTogJ3N0cmluZycgfSxcbiAgICBkaWZmaWN1bHR5X2NsYXNzOiB7IHR5cGU6ICdudW1iZXInIH0sXG4gICAgZGVzY3JpcHRpb246IHsgdHlwZTogJ3N0cmluZycgfSxcbiAgfSxcbiAgcmVxdWlyZWQ6IFsnYXR0cmlidXRlJywgJ2RpZmZpY3VsdHlfY2xhc3MnLCAnZGVzY3JpcHRpb24nXSxcbn07XG5cbmNvbnN0IGdlbmVyYXRlSW1hZ2VTY2hlbWEgPSB7XG4gIHR5cGU6ICdvYmplY3QnLFxuICBwcm9wZXJ0aWVzOiB7XG4gICAgcHJvbXB0OiB7IHR5cGU6ICdzdHJpbmcnIH0sXG4gIH0sXG4gIHJlcXVpcmVkOiBbJ3Byb21wdCddLFxufTtcblxuY29uc3QgdHJpZ2dlckdhbWVPdmVyU2NoZW1hID0ge1xuICB0eXBlOiAnb2JqZWN0JyxcbiAgcHJvcGVydGllczoge1xuICAgIGNhdXNlT2ZEZWF0aDogeyB0eXBlOiAnc3RyaW5nJyB9LFxuICAgIHdvcmxkRnV0dXJlOiB7IHR5cGU6ICdzdHJpbmcnIH0sXG4gIH0sXG4gIHJlcXVpcmVkOiBbJ2NhdXNlT2ZEZWF0aCcsICd3b3JsZEZ1dHVyZSddLFxufTtcblxuY29uc3QgdXBkYXRlQ2hhcmFjdGVyU2NoZW1hID0ge1xuICB0eXBlOiAnb2JqZWN0JyxcbiAgcHJvcGVydGllczoge1xuICAgIHByb2Zlc3Npb246IHsgdHlwZTogJ3N0cmluZycgfSxcbiAgICBocDogeyB0eXBlOiAnbnVtYmVyJyB9LFxuICAgIGludmVudG9yeTogeyB0eXBlOiAnYXJyYXknLCBpdGVtczogeyB0eXBlOiAnc3RyaW5nJyB9IH0sXG4gIH0sXG4gIHJlcXVpcmVkOiBbXSxcbn07XG5cbmZ1bmN0aW9uIHNhZmVQYXJzZUFyZ3MoYXJnczogdW5rbm93bik6IFJlY29yZDxzdHJpbmcsIGFueT4ge1xuICBpZiAoIWFyZ3MpIHJldHVybiB7fTtcbiAgaWYgKHR5cGVvZiBhcmdzID09PSAnb2JqZWN0JykgcmV0dXJuIGFyZ3MgYXMgUmVjb3JkPHN0cmluZywgYW55PjtcbiAgaWYgKHR5cGVvZiBhcmdzID09PSAnc3RyaW5nJykge1xuICAgIHRyeSB7XG4gICAgICByZXR1cm4gSlNPTi5wYXJzZShhcmdzKSBhcyBSZWNvcmQ8c3RyaW5nLCBhbnk+O1xuICAgIH0gY2F0Y2gge1xuICAgICAgcmV0dXJuIHt9O1xuICAgIH1cbiAgfVxuICByZXR1cm4ge307XG59XG5cbmZ1bmN0aW9uIG5vcm1hbGl6ZVRvb2xDYWxscyhyYXdDYWxsczogYW55W10gfCB1bmRlZmluZWQpIHtcbiAgY29uc3QgY2FsbHMgPSBBcnJheS5pc0FycmF5KHJhd0NhbGxzKSA/IHJhd0NhbGxzIDogW107XG4gIHJldHVybiBjYWxscy5tYXAoKGNhbGwpID0+ICh7XG4gICAgaWQ6IGNhbGw/LmlkLFxuICAgIG5hbWU6IGNhbGw/LmZ1bmN0aW9uPy5uYW1lIHx8IGNhbGw/Lm5hbWUsXG4gICAgYXJnczogc2FmZVBhcnNlQXJncyhjYWxsPy5mdW5jdGlvbj8uYXJndW1lbnRzID8/IGNhbGw/LmFyZ3MpLFxuICB9KSk7XG59XG5cbmZ1bmN0aW9uIGV4dHJhY3RSZXRyeUFmdGVyU2Vjb25kcyhlcnJvcjogYW55KTogbnVtYmVyIHwgbnVsbCB7XG4gIGlmICghZXJyb3IpIHJldHVybiBudWxsO1xuICBjb25zdCBoZWFkZXJWYWwgPVxuICAgIGVycm9yPy5yZXNwb25zZT8uaGVhZGVycz8uWydyZXRyeS1hZnRlciddIHx8XG4gICAgZXJyb3I/LnJlc3BvbnNlPy5oZWFkZXJzPy5nZXQ/LigncmV0cnktYWZ0ZXInKSB8fFxuICAgIGVycm9yPy5oZWFkZXJzPy5bJ3JldHJ5LWFmdGVyJ107XG4gIGlmICh0eXBlb2YgaGVhZGVyVmFsID09PSAnc3RyaW5nJykge1xuICAgIGNvbnN0IHBhcnNlZCA9IE51bWJlcihoZWFkZXJWYWwpO1xuICAgIGlmIChOdW1iZXIuaXNGaW5pdGUocGFyc2VkKSkgcmV0dXJuIHBhcnNlZDtcbiAgfVxuICBjb25zdCBkZXRhaWxzID0gZXJyb3I/LmRldGFpbHMgfHwgZXJyb3I/LmVycm9yPy5kZXRhaWxzO1xuICBpZiAoQXJyYXkuaXNBcnJheShkZXRhaWxzKSkge1xuICAgIGNvbnN0IHJldHJ5ID0gZGV0YWlscy5maW5kKChkKSA9PiBTdHJpbmcoZD8uWydAdHlwZSddIHx8ICcnKS5pbmNsdWRlcygnUmV0cnlJbmZvJykpO1xuICAgIGNvbnN0IGRlbGF5ID0gcmV0cnk/LnJldHJ5RGVsYXkgfHwgcmV0cnk/LlsncmV0cnlEZWxheSddO1xuICAgIGlmICh0eXBlb2YgZGVsYXkgPT09ICdzdHJpbmcnKSB7XG4gICAgICBjb25zdCBtYXRjaCA9IGRlbGF5Lm1hdGNoKC8oXFxkKylzLyk7XG4gICAgICBpZiAobWF0Y2gpIHJldHVybiBOdW1iZXIobWF0Y2hbMV0pO1xuICAgIH1cbiAgfVxuICBjb25zdCBtc2cgPSB0eXBlb2YgZXJyb3I/Lm1lc3NhZ2UgPT09ICdzdHJpbmcnID8gZXJyb3IubWVzc2FnZSA6ICcnO1xuICBjb25zdCBtc2dNYXRjaCA9IG1zZy5tYXRjaCgvXCJyZXRyeURlbGF5XCJcXHMqOlxccypcIihcXGQrKXNcIi8pO1xuICBpZiAobXNnTWF0Y2gpIHJldHVybiBOdW1iZXIobXNnTWF0Y2hbMV0pO1xuICByZXR1cm4gbnVsbDtcbn1cblxuY29uc3QgYm9keVNjaGVtYSA9IHoub2JqZWN0KHtcbiAgY2FtcGFpZ246IHouY3VzdG9tPENhbXBhaWduPigpLFxuICBtZXNzYWdlczogei5hcnJheSh6LmN1c3RvbTxNZXNzYWdlPigpKSxcbiAgaW5wdXQ6IHouc3RyaW5nKCkub3B0aW9uYWwoKSxcbiAgdG9vbFJlc3BvbnNlOiB6XG4gICAgLm9iamVjdCh7XG4gICAgICBuYW1lOiB6LnN0cmluZygpLFxuICAgICAgcmVzdWx0OiB6LmFueSgpLFxuICAgICAgY2FsbElkOiB6LnN0cmluZygpLm9wdGlvbmFsKCksXG4gICAgICBhcmdzOiB6LnJlY29yZCh6LmFueSgpKS5vcHRpb25hbCgpLFxuICAgIH0pXG4gICAgLm9wdGlvbmFsKCksXG59KTtcblxuZnVuY3Rpb24gbWFwUm9sZShyb2xlOiBSb2xlKTogJ3VzZXInIHwgJ2Fzc2lzdGFudCcgfCAnc3lzdGVtJyB7XG4gIGlmIChyb2xlID09PSBSb2xlLlVTRVIpIHJldHVybiAndXNlcic7XG4gIGlmIChyb2xlID09PSBSb2xlLk1PREVMKSByZXR1cm4gJ2Fzc2lzdGFudCc7XG4gIHJldHVybiAnc3lzdGVtJztcbn1cblxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIFBPU1QocmVxOiBSZXF1ZXN0KSB7XG4gIHRyeSB7XG4gICAgY29uc3QganNvbiA9IGF3YWl0IHJlcS5qc29uKCk7XG4gICAgY29uc3QgcGFyc2VkID0gYm9keVNjaGVtYS5zYWZlUGFyc2UoanNvbik7XG4gICAgaWYgKCFwYXJzZWQuc3VjY2Vzcykge1xuICAgICAgcmV0dXJuIE5leHRSZXNwb25zZS5qc29uKHsgZXJyb3I6ICdJbnZhbGlkIHBheWxvYWQnIH0sIHsgc3RhdHVzOiA0MDAgfSk7XG4gICAgfVxuXG4gICAgY29uc3QgeyBjYW1wYWlnbiwgbWVzc2FnZXMsIGlucHV0LCB0b29sUmVzcG9uc2UgfSA9IHBhcnNlZC5kYXRhO1xuICAgIGNvbnN0IHVzZXJLZXkgPSByZXEuaGVhZGVycy5nZXQoJ3gtY3VzdG9tLWFwaS1rZXknKSB8fCB1bmRlZmluZWQ7XG4gICAgbGV0IGFwaUtleTogc3RyaW5nO1xuICAgIHRyeSB7XG4gICAgICBhcGlLZXkgPSBwaWNrQXBpS2V5KHVzZXJLZXkpO1xuICAgIH0gY2F0Y2gge1xuICAgICAgcmV0dXJuIE5leHRSZXNwb25zZS5qc29uKHsgZXJyb3I6ICdNaXNzaW5nIEFQSSBrZXknIH0sIHsgc3RhdHVzOiA0MDEgfSk7XG4gICAgfVxuICAgIGNvbnN0IGFpID0gbmV3IEdyb3EoeyBhcGlLZXkgfSk7XG5cbiAgICBjb25zdCBhdXRoSGVhZGVyID0gcmVxLmhlYWRlcnMuZ2V0KCdhdXRob3JpemF0aW9uJykgfHwgJyc7XG4gICAgY29uc3QgdG9rZW4gPSBhdXRoSGVhZGVyLnN0YXJ0c1dpdGgoJ0JlYXJlciAnKSA/IGF1dGhIZWFkZXIuc2xpY2UoNykgOiAnJztcbiAgICBpZiAoIXRva2VuKSB7XG4gICAgICByZXR1cm4gTmV4dFJlc3BvbnNlLmpzb24oeyBlcnJvcjogJ01pc3NpbmcgYXV0aCB0b2tlbicgfSwgeyBzdGF0dXM6IDQwMSB9KTtcbiAgICB9XG5cbiAgICBjb25zdCBzYiA9IGNyZWF0ZVNlcnZlckNsaWVudCh0b2tlbik7XG4gICAgY29uc3QgeyBkYXRhOiB1c2VyRGF0YSB9ID0gYXdhaXQgc2IuYXV0aC5nZXRVc2VyKHRva2VuKTtcbiAgICBpZiAoIXVzZXJEYXRhLnVzZXI/LmlkKSB7XG4gICAgICByZXR1cm4gTmV4dFJlc3BvbnNlLmpzb24oeyBlcnJvcjogJ1VuYXV0aG9yaXplZCcgfSwgeyBzdGF0dXM6IDQwMSB9KTtcbiAgICB9XG5cbiAgICBjb25zdCByYXRlS2V5ID0gYGNoYXQ6JHt1c2VyRGF0YS51c2VyLmlkfToke2NhbXBhaWduLmlkfWA7XG4gICAgaWYgKGF3YWl0IGlzUmF0ZUxpbWl0ZWQocmF0ZUtleSkpIHtcbiAgICAgIHJldHVybiBOZXh0UmVzcG9uc2UuanNvbih7IGVycm9yOiAnUmF0ZSBsaW1pdCBleGNlZWRlZCcgfSwgeyBzdGF0dXM6IDQyOSB9KTtcbiAgICB9XG5cbiAgICBjb25zdCB7IGRhdGE6IGNhbXBhaWduUm93IH0gPSBhd2FpdCBzYlxuICAgICAgLmZyb20oJ2NhbXBhaWducycpXG4gICAgICAuc2VsZWN0KCdzdGF0dXMsIG93bmVyX2lkJylcbiAgICAgIC5lcSgnaWQnLCBjYW1wYWlnbi5pZClcbiAgICAgIC5tYXliZVNpbmdsZSgpO1xuXG4gICAgY29uc3QgeyBkYXRhOiBtZW1iZXJzaGlwIH0gPSBhd2FpdCBzYlxuICAgICAgLmZyb20oJ2NhbXBhaWduX3BsYXllcnMnKVxuICAgICAgLnNlbGVjdCgnc3RhdHVzLGlzX2RlYWQsY2hhcmFjdGVyX2RhdGFfanNvbicpXG4gICAgICAuZXEoJ2NhbXBhaWduX2lkJywgY2FtcGFpZ24uaWQpXG4gICAgICAuZXEoJ3BsYXllcl9pZCcsIHVzZXJEYXRhLnVzZXIuaWQpXG4gICAgICAubWF5YmVTaW5nbGUoKTtcblxuICAgIGlmICghbWVtYmVyc2hpcCAmJiBjYW1wYWlnblJvdz8ub3duZXJfaWQgIT09IHVzZXJEYXRhLnVzZXIuaWQpIHtcbiAgICAgIHJldHVybiBOZXh0UmVzcG9uc2UuanNvbih7IGVycm9yOiAnRm9yYmlkZGVuJyB9LCB7IHN0YXR1czogNDAzIH0pO1xuICAgIH1cblxuICAgIGlmIChtZW1iZXJzaGlwPy5pc19kZWFkKSB7XG4gICAgICByZXR1cm4gTmV4dFJlc3BvbnNlLmpzb24oeyBlcnJvcjogJ0NoYXJhY3RlciBpcyBkZWFkJyB9LCB7IHN0YXR1czogNDAzIH0pO1xuICAgIH1cblxuICAgIGlmICghY2FtcGFpZ25Sb3cpIHtcbiAgICAgIHJldHVybiBOZXh0UmVzcG9uc2UuanNvbih7IGVycm9yOiAnQ2FtcGFpZ24gbm90IGZvdW5kJyB9LCB7IHN0YXR1czogNDA0IH0pO1xuICAgIH1cblxuICAgIGNvbnN0IGVmZmVjdGl2ZVN0YXR1cyA9IGNhbXBhaWduUm93LnN0YXR1cyB8fCBjYW1wYWlnbi5zdGF0dXM7XG4gICAgaWYgKGVmZmVjdGl2ZVN0YXR1cyA9PT0gJ3dhaXRpbmdfZm9yX3BsYXllcnMnIHx8IGVmZmVjdGl2ZVN0YXR1cyA9PT0gJ3BhdXNlZCcpIHtcbiAgICAgIHJldHVybiBOZXh0UmVzcG9uc2UuanNvbih7IHRleHQ6ICdbU0lTVEVNQV0gTWVzYSBlbSBlc3BlcmEuJywgdG9vbENhbGxzOiBbXSB9KTtcbiAgICB9XG5cbiAgICBjb25zdCBzeXN0ZW0gPSBidWlsZFN5c3RlbVByb21wdChjYW1wYWlnbik7XG5cbiAgICBjb25zdCBoaXN0b3J5ID0gbWVzc2FnZXNcbiAgICAgIC5maWx0ZXIoKG0pID0+IG0ucm9sZSAhPT0gUm9sZS5TWVNURU0pXG4gICAgICAubWFwKChtKSA9PiAoe1xuICAgICAgICByb2xlOiBtLnJvbGUgPT09IFJvbGUuVVNFUiA/ICd1c2VyJyA6ICdhc3Npc3RhbnQnLFxuICAgICAgICBjb250ZW50OiBtLmNvbnRlbnQgfHwgJycsXG4gICAgICB9KSk7XG5cbiAgICBjb25zdCB0b29scyA9IFtcbiAgICAgIHtcbiAgICAgICAgdHlwZTogJ2Z1bmN0aW9uJyxcbiAgICAgICAgZnVuY3Rpb246IHtcbiAgICAgICAgICBuYW1lOiAncmVxdWVzdF9yb2xsJyxcbiAgICAgICAgICBkZXNjcmlwdGlvbjogJ1JlcXVlc3QgYSBkaWNlIHJvbGwgZnJvbSB0aGUgcGxheWVyLicsXG4gICAgICAgICAgcGFyYW1ldGVyczogcmVxdWVzdFJvbGxTY2hlbWEgYXMgYW55LFxuICAgICAgICB9LFxuICAgICAgfSxcbiAgICAgIHtcbiAgICAgICAgdHlwZTogJ2Z1bmN0aW9uJyxcbiAgICAgICAgZnVuY3Rpb246IHtcbiAgICAgICAgICBuYW1lOiAnZ2VuZXJhdGVfaW1hZ2UnLFxuICAgICAgICAgIGRlc2NyaXB0aW9uOiAnR2VuZXJhdGUgYW4gaW1hZ2UgcHJvbXB0IGZvciB0aGUgc3RvcnkuJyxcbiAgICAgICAgICBwYXJhbWV0ZXJzOiBnZW5lcmF0ZUltYWdlU2NoZW1hIGFzIGFueSxcbiAgICAgICAgfSxcbiAgICAgIH0sXG4gICAgICB7XG4gICAgICAgIHR5cGU6ICdmdW5jdGlvbicsXG4gICAgICAgIGZ1bmN0aW9uOiB7XG4gICAgICAgICAgbmFtZTogJ3RyaWdnZXJfZ2FtZV9vdmVyJyxcbiAgICAgICAgICBkZXNjcmlwdGlvbjogJ1RyaWdnZXIgYSBnYW1lIG92ZXIgd2hlbiB0aGUgcGxheWVyIGRpZXMuJyxcbiAgICAgICAgICBwYXJhbWV0ZXJzOiB0cmlnZ2VyR2FtZU92ZXJTY2hlbWEgYXMgYW55LFxuICAgICAgICB9LFxuICAgICAgfSxcbiAgICAgIHtcbiAgICAgICAgdHlwZTogJ2Z1bmN0aW9uJyxcbiAgICAgICAgZnVuY3Rpb246IHtcbiAgICAgICAgICBuYW1lOiAndXBkYXRlX2NoYXJhY3RlcicsXG4gICAgICAgICAgZGVzY3JpcHRpb246ICdVcGRhdGUgY2hhcmFjdGVyIGZpZWxkcyBsaWtlIHByb2Zlc3Npb24sIGhwLCBvciBpbnZlbnRvcnkgd2hlbiB0aGUgc3RvcnkgY2hhbmdlcy4nLFxuICAgICAgICAgIHBhcmFtZXRlcnM6IHVwZGF0ZUNoYXJhY3RlclNjaGVtYSBhcyBhbnksXG4gICAgICAgIH0sXG4gICAgICB9LFxuICAgIF07XG5cbiAgICBjb25zdCBiYXNlTWVzc2FnZXMgPSBbeyByb2xlOiAnc3lzdGVtJywgY29udGVudDogc3lzdGVtIH0sIC4uLmhpc3RvcnldO1xuXG4gICAgY29uc3QgYnVpbGRNZXNzYWdlcyA9ICgpID0+IHtcbiAgICAgIGlmICh0b29sUmVzcG9uc2UpIHtcbiAgICAgICAgY29uc3QgdG9vbENhbGxJZCA9IHRvb2xSZXNwb25zZS5jYWxsSWQgfHwgYGNhbGxfJHt0b29sUmVzcG9uc2UubmFtZX1gO1xuICAgICAgICBjb25zdCB0b29sQXJncyA9IHRvb2xSZXNwb25zZS5hcmdzIHx8IHt9O1xuICAgICAgICByZXR1cm4gW1xuICAgICAgICAgIC4uLmJhc2VNZXNzYWdlcyxcbiAgICAgICAgICB7XG4gICAgICAgICAgICByb2xlOiAnYXNzaXN0YW50JyxcbiAgICAgICAgICAgIGNvbnRlbnQ6ICcnLFxuICAgICAgICAgICAgdG9vbF9jYWxsczogW1xuICAgICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAgaWQ6IHRvb2xDYWxsSWQsXG4gICAgICAgICAgICAgICAgdHlwZTogJ2Z1bmN0aW9uJyxcbiAgICAgICAgICAgICAgICBmdW5jdGlvbjoge1xuICAgICAgICAgICAgICAgICAgbmFtZTogdG9vbFJlc3BvbnNlLm5hbWUsXG4gICAgICAgICAgICAgICAgICBhcmd1bWVudHM6IEpTT04uc3RyaW5naWZ5KHRvb2xBcmdzKSxcbiAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgXSxcbiAgICAgICAgICB9LFxuICAgICAgICAgIHtcbiAgICAgICAgICAgIHJvbGU6ICd0b29sJyxcbiAgICAgICAgICAgIHRvb2xfY2FsbF9pZDogdG9vbENhbGxJZCxcbiAgICAgICAgICAgIGNvbnRlbnQ6IEpTT04uc3RyaW5naWZ5KHRvb2xSZXNwb25zZS5yZXN1bHQgPz8gJycpLFxuICAgICAgICAgIH0sXG4gICAgICAgIF07XG4gICAgICB9XG5cbiAgICAgIGlmIChpbnB1dCAmJiBpbnB1dC50cmltKCkubGVuZ3RoID4gMCkge1xuICAgICAgICByZXR1cm4gWy4uLmJhc2VNZXNzYWdlcywgeyByb2xlOiAndXNlcicsIGNvbnRlbnQ6IGlucHV0IH1dO1xuICAgICAgfVxuXG4gICAgICByZXR1cm4gYmFzZU1lc3NhZ2VzO1xuICAgIH07XG5cbiAgICBjb25zdCB3YW50c1N0cmVhbSA9XG4gICAgICByZXEuaGVhZGVycy5nZXQoJ2FjY2VwdCcpPy5pbmNsdWRlcygndGV4dC9ldmVudC1zdHJlYW0nKSB8fFxuICAgICAgcmVxLmhlYWRlcnMuZ2V0KCd4LXN0cmVhbScpID09PSAnMSc7XG5cbiAgICBpZiAod2FudHNTdHJlYW0gJiYgU1RSRUFNSU5HX0VOQUJMRUQpIHtcbiAgICAgIGxldCBzdHJlYW1SZXN1bHQ6IGFueTtcbiAgICAgIHRyeSB7XG4gICAgICAgIHN0cmVhbVJlc3VsdCA9IGF3YWl0IHdpdGhNb2RlbEZhbGxiYWNrKFxuICAgICAgICAgIChtb2RlbCkgPT5cbiAgICAgICAgICAgIGFpLmNoYXQuY29tcGxldGlvbnMuY3JlYXRlKHtcbiAgICAgICAgICAgICAgbW9kZWwsXG4gICAgICAgICAgICAgIG1lc3NhZ2VzOiBidWlsZE1lc3NhZ2VzKCksXG4gICAgICAgICAgICAgIHRvb2xzLFxuICAgICAgICAgICAgICB0b29sX2Nob2ljZTogJ2F1dG8nLFxuICAgICAgICAgICAgICB0ZW1wZXJhdHVyZTogMC44LFxuICAgICAgICAgICAgICBzdHJlYW06IHRydWUsXG4gICAgICAgICAgICB9KSxcbiAgICAgICAgICB7IGtleTogYGNoYXQ6JHtjYW1wYWlnbi5pZH1gIH1cbiAgICAgICAgKTtcbiAgICAgIH0gY2F0Y2ggKGVycjogYW55KSB7XG4gICAgICAgIGNvbnN0IHN0YXR1cyA9IGVycj8uc3RhdHVzIHx8IGVycj8uY29kZSB8fCA1MDA7XG4gICAgICAgIGlmIChzdGF0dXMgPT09IDQyOSkge1xuICAgICAgICAgIGNvbnN0IHJldHJ5QWZ0ZXIgPSBleHRyYWN0UmV0cnlBZnRlclNlY29uZHMoZXJyKTtcbiAgICAgICAgICByZXR1cm4gTmV4dFJlc3BvbnNlLmpzb24oXG4gICAgICAgICAgICB7IGVycm9yOiAnUmF0ZSBsaW1pdCBleGNlZWRlZCcsIHJldHJ5QWZ0ZXIgfSxcbiAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgc3RhdHVzOiA0MjksXG4gICAgICAgICAgICAgIGhlYWRlcnM6IHJldHJ5QWZ0ZXIgPyB7ICdSZXRyeS1BZnRlcic6IFN0cmluZyhyZXRyeUFmdGVyKSB9IDogdW5kZWZpbmVkLFxuICAgICAgICAgICAgfVxuICAgICAgICAgICk7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIE5leHRSZXNwb25zZS5qc29uKHsgZXJyb3I6ICdTZXJ2ZXIgZXJyb3InIH0sIHsgc3RhdHVzOiA1MDAgfSk7XG4gICAgICB9XG5cbiAgICAgIGNvbnN0IGVuY29kZXIgPSBuZXcgVGV4dEVuY29kZXIoKTtcbiAgICAgIGNvbnN0IHN0cmVhbSA9IG5ldyBSZWFkYWJsZVN0cmVhbSh7XG4gICAgICAgIGFzeW5jIHN0YXJ0KGNvbnRyb2xsZXIpIHtcbiAgICAgICAgICBsZXQgZnVsbFRleHQgPSAnJztcbiAgICAgICAgICBjb25zdCB0b29sQ2FsbE1hcCA9IG5ldyBNYXA8c3RyaW5nLCB7IGlkOiBzdHJpbmc7IG5hbWU/OiBzdHJpbmc7IGFyZ3NUZXh0OiBzdHJpbmcgfT4oKTtcbiAgICAgICAgICB0cnkge1xuICAgICAgICAgICAgZm9yIGF3YWl0IChjb25zdCBjaHVuayBvZiBzdHJlYW1SZXN1bHQpIHtcbiAgICAgICAgICAgICAgY29uc3QgZGVsdGEgPSBjaHVuaz8uY2hvaWNlcz8uWzBdPy5kZWx0YSB8fCB7fTtcbiAgICAgICAgICAgICAgY29uc3QgdGV4dENodW5rID0gZGVsdGE/LmNvbnRlbnQgfHwgJyc7XG4gICAgICAgICAgICAgIGNvbnN0IGRlbHRhVG9vbENhbGxzID0gQXJyYXkuaXNBcnJheShkZWx0YT8udG9vbF9jYWxscykgPyBkZWx0YS50b29sX2NhbGxzIDogW107XG5cbiAgICAgICAgICAgICAgZm9yIChjb25zdCBjYWxsIG9mIGRlbHRhVG9vbENhbGxzKSB7XG4gICAgICAgICAgICAgICAgY29uc3QgY2FsbElkID0gY2FsbD8uaWQgfHwgYGNhbGxfJHtjYWxsPy5mdW5jdGlvbj8ubmFtZSB8fCBjYWxsPy5pbmRleCB8fCAndG9vbCd9YDtcbiAgICAgICAgICAgICAgICBjb25zdCBleGlzdGluZyA9IHRvb2xDYWxsTWFwLmdldChjYWxsSWQpIHx8IHsgaWQ6IGNhbGxJZCwgbmFtZTogY2FsbD8uZnVuY3Rpb24/Lm5hbWUsIGFyZ3NUZXh0OiAnJyB9O1xuICAgICAgICAgICAgICAgIGlmIChjYWxsPy5mdW5jdGlvbj8ubmFtZSkge1xuICAgICAgICAgICAgICAgICAgZXhpc3RpbmcubmFtZSA9IGNhbGwuZnVuY3Rpb24ubmFtZTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgaWYgKGNhbGw/LmZ1bmN0aW9uPy5hcmd1bWVudHMpIHtcbiAgICAgICAgICAgICAgICAgIGV4aXN0aW5nLmFyZ3NUZXh0ICs9IGNhbGwuZnVuY3Rpb24uYXJndW1lbnRzO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB0b29sQ2FsbE1hcC5zZXQoY2FsbElkLCBleGlzdGluZyk7XG4gICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICBpZiAodGV4dENodW5rKSB7XG4gICAgICAgICAgICAgICAgZnVsbFRleHQgKz0gdGV4dENodW5rO1xuICAgICAgICAgICAgICAgIGNvbnRyb2xsZXIuZW5xdWV1ZShcbiAgICAgICAgICAgICAgICAgIGVuY29kZXIuZW5jb2RlKGBkYXRhOiAke0pTT04uc3RyaW5naWZ5KHsgdHlwZTogJ3Rva2VuJywgdmFsdWU6IHRleHRDaHVuayB9KX1cXG5cXG5gKVxuICAgICAgICAgICAgICAgICk7XG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgY29uc3QgdG9vbENhbGxzID0gQXJyYXkuZnJvbSh0b29sQ2FsbE1hcC52YWx1ZXMoKSkubWFwKChjYWxsKSA9PiAoe1xuICAgICAgICAgICAgICBpZDogY2FsbC5pZCxcbiAgICAgICAgICAgICAgbmFtZTogY2FsbC5uYW1lLFxuICAgICAgICAgICAgICBhcmdzOiBzYWZlUGFyc2VBcmdzKGNhbGwuYXJnc1RleHQpLFxuICAgICAgICAgICAgfSkpO1xuXG4gICAgICAgICAgICBjb250cm9sbGVyLmVucXVldWUoXG4gICAgICAgICAgICAgIGVuY29kZXIuZW5jb2RlKFxuICAgICAgICAgICAgICAgIGBkYXRhOiAke0pTT04uc3RyaW5naWZ5KHsgdHlwZTogJ2RvbmUnLCB0ZXh0OiBmdWxsVGV4dCB8fCAnJywgdG9vbENhbGxzIH0pfVxcblxcbmBcbiAgICAgICAgICAgICAgKVxuICAgICAgICAgICAgKTtcbiAgICAgICAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgICAgICAgIGNvbnRyb2xsZXIuZW5xdWV1ZShcbiAgICAgICAgICAgICAgZW5jb2Rlci5lbmNvZGUoYGRhdGE6ICR7SlNPTi5zdHJpbmdpZnkoeyB0eXBlOiAnZXJyb3InLCBtZXNzYWdlOiAnc3RyZWFtX2Vycm9yJyB9KX1cXG5cXG5gKVxuICAgICAgICAgICAgKTtcbiAgICAgICAgICB9IGZpbmFsbHkge1xuICAgICAgICAgICAgY29udHJvbGxlci5jbG9zZSgpO1xuICAgICAgICAgIH1cbiAgICAgICAgfSxcbiAgICAgIH0pO1xuXG4gICAgICByZXR1cm4gbmV3IFJlc3BvbnNlKHN0cmVhbSwge1xuICAgICAgICBoZWFkZXJzOiB7XG4gICAgICAgICAgJ0NvbnRlbnQtVHlwZSc6ICd0ZXh0L2V2ZW50LXN0cmVhbTsgY2hhcnNldD11dGYtOCcsXG4gICAgICAgICAgJ0NhY2hlLUNvbnRyb2wnOiAnbm8tY2FjaGUsIG5vLXRyYW5zZm9ybScsXG4gICAgICAgICAgQ29ubmVjdGlvbjogJ2tlZXAtYWxpdmUnLFxuICAgICAgICB9LFxuICAgICAgfSk7XG4gICAgfVxuXG4gICAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCB3aXRoTW9kZWxGYWxsYmFjayhcbiAgICAgIChtb2RlbCkgPT5cbiAgICAgICAgYWkuY2hhdC5jb21wbGV0aW9ucy5jcmVhdGUoe1xuICAgICAgICAgIG1vZGVsLFxuICAgICAgICAgIG1lc3NhZ2VzOiBidWlsZE1lc3NhZ2VzKCksXG4gICAgICAgICAgdG9vbHMsXG4gICAgICAgICAgdG9vbF9jaG9pY2U6ICdhdXRvJyxcbiAgICAgICAgICB0ZW1wZXJhdHVyZTogMC44LFxuICAgICAgICB9KSxcbiAgICAgIHsga2V5OiBgY2hhdDoke2NhbXBhaWduLmlkfWAgfVxuICAgICk7XG5cbiAgICBjb25zdCBtZXNzYWdlID0gcmVzcG9uc2UuY2hvaWNlcz8uWzBdPy5tZXNzYWdlO1xuICAgIGNvbnN0IHRleHQgPSBtZXNzYWdlPy5jb250ZW50IHx8ICcnO1xuICAgIGNvbnN0IHRvb2xDYWxscyA9IG5vcm1hbGl6ZVRvb2xDYWxscyhtZXNzYWdlPy50b29sX2NhbGxzKTtcblxuICAgIHJldHVybiBOZXh0UmVzcG9uc2UuanNvbih7XG4gICAgICB0ZXh0OiB0ZXh0IHx8ICcnLFxuICAgICAgdG9vbENhbGxzLFxuICAgIH0pO1xuICB9IGNhdGNoIChlcnJvcjogYW55KSB7XG4gICAgY29uc3Qgc3RhdHVzID0gZXJyb3I/LnN0YXR1cyB8fCBlcnJvcj8uY29kZSB8fCA1MDA7XG4gICAgY29uc29sZS5lcnJvcignQ2hhdCBBUEkgZXJyb3I6JywgZXJyb3IpO1xuICAgIGlmIChzdGF0dXMgPT09IDQyOSkge1xuICAgICAgY29uc3QgcmV0cnlBZnRlciA9IGV4dHJhY3RSZXRyeUFmdGVyU2Vjb25kcyhlcnJvcik7XG4gICAgICByZXR1cm4gTmV4dFJlc3BvbnNlLmpzb24oXG4gICAgICAgIHsgZXJyb3I6ICdSYXRlIGxpbWl0IGV4Y2VlZGVkJywgcmV0cnlBZnRlciB9LFxuICAgICAgICB7IHN0YXR1czogNDI5LCBoZWFkZXJzOiByZXRyeUFmdGVyID8geyAnUmV0cnktQWZ0ZXInOiBTdHJpbmcocmV0cnlBZnRlcikgfSA6IHVuZGVmaW5lZCB9XG4gICAgICApO1xuICAgIH1cbiAgICByZXR1cm4gTmV4dFJlc3BvbnNlLmpzb24oeyBlcnJvcjogJ1NlcnZlciBlcnJvcicgfSwgeyBzdGF0dXM6IDUwMCB9KTtcbiAgfVxufVxuIl0sIm5hbWVzIjpbIk5leHRSZXNwb25zZSIsIkdyb3EiLCJ6IiwicGlja0FwaUtleSIsImJ1aWxkU3lzdGVtUHJvbXB0IiwiaXNSYXRlTGltaXRlZCIsIndpdGhNb2RlbEZhbGxiYWNrIiwiUm9sZSIsImNyZWF0ZVNlcnZlckNsaWVudCIsIlNUUkVBTUlOR19FTkFCTEVEIiwicmVxdWVzdFJvbGxTY2hlbWEiLCJ0eXBlIiwicHJvcGVydGllcyIsImF0dHJpYnV0ZSIsImRpZmZpY3VsdHlfY2xhc3MiLCJkZXNjcmlwdGlvbiIsInJlcXVpcmVkIiwiZ2VuZXJhdGVJbWFnZVNjaGVtYSIsInByb21wdCIsInRyaWdnZXJHYW1lT3ZlclNjaGVtYSIsImNhdXNlT2ZEZWF0aCIsIndvcmxkRnV0dXJlIiwidXBkYXRlQ2hhcmFjdGVyU2NoZW1hIiwicHJvZmVzc2lvbiIsImhwIiwiaW52ZW50b3J5IiwiaXRlbXMiLCJzYWZlUGFyc2VBcmdzIiwiYXJncyIsIkpTT04iLCJwYXJzZSIsIm5vcm1hbGl6ZVRvb2xDYWxscyIsInJhd0NhbGxzIiwiY2FsbHMiLCJBcnJheSIsImlzQXJyYXkiLCJtYXAiLCJjYWxsIiwiaWQiLCJuYW1lIiwiZnVuY3Rpb24iLCJhcmd1bWVudHMiLCJleHRyYWN0UmV0cnlBZnRlclNlY29uZHMiLCJlcnJvciIsImhlYWRlclZhbCIsInJlc3BvbnNlIiwiaGVhZGVycyIsImdldCIsInBhcnNlZCIsIk51bWJlciIsImlzRmluaXRlIiwiZGV0YWlscyIsInJldHJ5IiwiZmluZCIsImQiLCJTdHJpbmciLCJpbmNsdWRlcyIsImRlbGF5IiwicmV0cnlEZWxheSIsIm1hdGNoIiwibXNnIiwibWVzc2FnZSIsIm1zZ01hdGNoIiwiYm9keVNjaGVtYSIsIm9iamVjdCIsImNhbXBhaWduIiwiY3VzdG9tIiwibWVzc2FnZXMiLCJhcnJheSIsImlucHV0Iiwic3RyaW5nIiwib3B0aW9uYWwiLCJ0b29sUmVzcG9uc2UiLCJyZXN1bHQiLCJhbnkiLCJjYWxsSWQiLCJyZWNvcmQiLCJtYXBSb2xlIiwicm9sZSIsIlVTRVIiLCJNT0RFTCIsIlBPU1QiLCJyZXEiLCJqc29uIiwic2FmZVBhcnNlIiwic3VjY2VzcyIsInN0YXR1cyIsImRhdGEiLCJ1c2VyS2V5IiwidW5kZWZpbmVkIiwiYXBpS2V5IiwiYWkiLCJhdXRoSGVhZGVyIiwidG9rZW4iLCJzdGFydHNXaXRoIiwic2xpY2UiLCJzYiIsInVzZXJEYXRhIiwiYXV0aCIsImdldFVzZXIiLCJ1c2VyIiwicmF0ZUtleSIsImNhbXBhaWduUm93IiwiZnJvbSIsInNlbGVjdCIsImVxIiwibWF5YmVTaW5nbGUiLCJtZW1iZXJzaGlwIiwib3duZXJfaWQiLCJpc19kZWFkIiwiZWZmZWN0aXZlU3RhdHVzIiwidGV4dCIsInRvb2xDYWxscyIsInN5c3RlbSIsImhpc3RvcnkiLCJmaWx0ZXIiLCJtIiwiU1lTVEVNIiwiY29udGVudCIsInRvb2xzIiwicGFyYW1ldGVycyIsImJhc2VNZXNzYWdlcyIsImJ1aWxkTWVzc2FnZXMiLCJ0b29sQ2FsbElkIiwidG9vbEFyZ3MiLCJ0b29sX2NhbGxzIiwic3RyaW5naWZ5IiwidG9vbF9jYWxsX2lkIiwidHJpbSIsImxlbmd0aCIsIndhbnRzU3RyZWFtIiwic3RyZWFtUmVzdWx0IiwibW9kZWwiLCJjaGF0IiwiY29tcGxldGlvbnMiLCJjcmVhdGUiLCJ0b29sX2Nob2ljZSIsInRlbXBlcmF0dXJlIiwic3RyZWFtIiwia2V5IiwiZXJyIiwiY29kZSIsInJldHJ5QWZ0ZXIiLCJlbmNvZGVyIiwiVGV4dEVuY29kZXIiLCJSZWFkYWJsZVN0cmVhbSIsInN0YXJ0IiwiY29udHJvbGxlciIsImZ1bGxUZXh0IiwidG9vbENhbGxNYXAiLCJNYXAiLCJjaHVuayIsImRlbHRhIiwiY2hvaWNlcyIsInRleHRDaHVuayIsImRlbHRhVG9vbENhbGxzIiwiaW5kZXgiLCJleGlzdGluZyIsImFyZ3NUZXh0Iiwic2V0IiwiZW5xdWV1ZSIsImVuY29kZSIsInZhbHVlIiwidmFsdWVzIiwiY2xvc2UiLCJSZXNwb25zZSIsIkNvbm5lY3Rpb24iLCJjb25zb2xlIl0sInNvdXJjZVJvb3QiOiIifQ==\n//# sourceURL=webpack-internal:///(rsc)/./app/api/chat/route.ts\n");

/***/ }),

/***/ "(rsc)/./constants.ts":
/*!**********************!*\
  !*** ./constants.ts ***!
  \**********************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

eval("__webpack_require__.r(__webpack_exports__);\n/* harmony export */ __webpack_require__.d(__webpack_exports__, {\n/* harmony export */   CLASSES_BY_SYSTEM: () => (/* binding */ CLASSES_BY_SYSTEM),\n/* harmony export */   INITIAL_SYSTEM_PROMPT_TEMPLATE: () => (/* binding */ INITIAL_SYSTEM_PROMPT_TEMPLATE),\n/* harmony export */   RPG_SYSTEMS: () => (/* binding */ RPG_SYSTEMS),\n/* harmony export */   SKILLS_BY_SYSTEM: () => (/* binding */ SKILLS_BY_SYSTEM),\n/* harmony export */   SUPPORTED_SYSTEMS: () => (/* binding */ SUPPORTED_SYSTEMS),\n/* harmony export */   normalizeSystemName: () => (/* binding */ normalizeSystemName)\n/* harmony export */ });\nconst RPG_SYSTEMS = {\n    \"Narrativo\": `\n    - Sistema Genrico Baseado em Narrativa (Foco em Histria).\n    - Rolagens: d20 Simples. 10+ Sucesso, 15+ Sucesso Bom, 20 Sucesso Crtico.\n    - Priorize a regra do legal (Rule of Cool).\n  `,\n    \"D&D 5e\": `\n    - Sistema: Dungeons & Dragons 5th Edition.\n    - Rolagens: d20 + Modificador vs Classe de Dificuldade (CD).\n    - Atributos: Fora, Destreza, Constituio, Inteligncia, Sabedoria, Carisma.\n    - REGRAS CRTICAS: Testes de Percepo (Sabedoria) para ouvir/notar, Investigao (Inteligncia) para procurar, Furtividade (Destreza) para esconder.\n  `,\n    \"Ordem Paranormal\": `\n    - Sistema: Ordem Paranormal RPG.\n    - Atributos principais: Fora, Agilidade, Intelecto, Presena, Vigor.\n    - Aes e testes usam d20 + atributo.\n    - Horror Investigativo. O Paranormal no vem para nossa realidade de forma fcil.\n  `,\n    \"Call of Cthulhu\": `\n    - Sistema: Baseado em BRP (d100).\n    - Atributos: Fora, Constituio, Destreza, Inteligncia, Poder, Aparncia, Educao, Tamanho.\n    - Testes usam percentuais; sucesso com resultado <= atributo.\n    - Foco em Horror Csmico, Investigao e Loucura.\n    - Combate  mortal e deve ser evitado.\n  `\n};\nconst SUPPORTED_SYSTEMS = [\n    \"Narrativo\",\n    \"D&D 5e\",\n    \"Ordem Paranormal\",\n    \"Call of Cthulhu\"\n];\nfunction normalizeSystemName(systemName) {\n    if (systemName && SUPPORTED_SYSTEMS.includes(systemName)) {\n        return systemName;\n    }\n    return \"Narrativo\";\n}\nconst SKILLS_BY_SYSTEM = {\n    \"Narrativo\": [\n        \"Atletismo\",\n        \"Furtividade\",\n        \"Percep\\xe7\\xe3o\",\n        \"Investiga\\xe7\\xe3o\",\n        \"Persuas\\xe3o\",\n        \"Intimida\\xe7\\xe3o\",\n        \"Engana\\xe7\\xe3o\",\n        \"Sobreviv\\xeancia\",\n        \"Medicina\",\n        \"Conhecimento\"\n    ],\n    \"D&D 5e\": [\n        \"Acrobatics (Acrobacia)\",\n        \"Animal Handling (Adestrar Animais)\",\n        \"Arcana (Arcano)\",\n        \"Athletics (Atletismo)\",\n        \"Deception (Engana\\xe7\\xe3o)\",\n        \"History (Hist\\xf3ria)\",\n        \"Insight (Intui\\xe7\\xe3o)\",\n        \"Intimidation (Intimida\\xe7\\xe3o)\",\n        \"Investigation (Investiga\\xe7\\xe3o)\",\n        \"Medicine (Medicina)\",\n        \"Nature (Natureza)\",\n        \"Perception (Percep\\xe7\\xe3o)\",\n        \"Performance (Atua\\xe7\\xe3o)\",\n        \"Persuasion (Persuas\\xe3o)\",\n        \"Religion (Religi\\xe3o)\",\n        \"Sleight of Hand (Prestidigita\\xe7\\xe3o)\",\n        \"Stealth (Furtividade)\",\n        \"Survival (Sobreviv\\xeancia)\"\n    ],\n    \"Ordem Paranormal\": [\n        \"Acrobacia\",\n        \"Adestramento\",\n        \"Artes\",\n        \"Atletismo\",\n        \"Atualidades\",\n        \"Engana\\xe7\\xe3o\",\n        \"Fortitude\",\n        \"Furtividade\",\n        \"Iniciativa\",\n        \"Intimida\\xe7\\xe3o\",\n        \"Investiga\\xe7\\xe3o\",\n        \"Intui\\xe7\\xe3o\",\n        \"Luta\",\n        \"Medicina\",\n        \"Ocultismo\",\n        \"Percep\\xe7\\xe3o\",\n        \"Persuas\\xe3o\",\n        \"Pilotagem\",\n        \"Pontaria\",\n        \"Reflexos\",\n        \"Tecnologia\",\n        \"Vontade\"\n    ],\n    \"Call of Cthulhu\": [\n        \"Accounting (Contabilidade)\",\n        \"Anthropology (Antropologia)\",\n        \"Archaeology (Arqueologia)\",\n        \"Art/Craft (Arte/Of\\xedcio)\",\n        \"Charm (L\\xe1bia)\",\n        \"Climb (Escalar)\",\n        \"Credit Rating (Cr\\xe9dito)\",\n        \"Disguise (Disfarce)\",\n        \"Dodge (Esquiva)\",\n        \"Drive Auto (Dirigir)\",\n        \"Fast Talk (L\\xe1bia R\\xe1pida)\",\n        \"First Aid (Primeiros Socorros)\",\n        \"History (Hist\\xf3ria)\",\n        \"Intimidate (Intimida\\xe7\\xe3o)\",\n        \"Jump (Saltar)\",\n        \"Law (Direito)\",\n        \"Library Use (Biblioteca)\",\n        \"Listen (Escutar)\",\n        \"Locksmith (Arrombamento)\",\n        \"Medicine (Medicina)\",\n        \"Natural World (Mundo Natural)\",\n        \"Occult (Ocultismo)\",\n        \"Operate Heavy Machinery (M\\xe1quinas Pesadas)\",\n        \"Persuade (Persuas\\xe3o)\",\n        \"Psychology (Psicologia)\",\n        \"Science (Ci\\xeancia)\",\n        \"Spot Hidden (Notar)\",\n        \"Stealth (Furtividade)\",\n        \"Survival (Sobreviv\\xeancia)\",\n        \"Swim (Nata\\xe7\\xe3o)\",\n        \"Throw (Arremesso)\",\n        \"Track (Rastrear)\"\n    ]\n};\nconst CLASSES_BY_SYSTEM = {\n    \"Narrativo\": [\n        \"Aventureiro\",\n        \"Explorador\",\n        \"Sobrevivente\",\n        \"Erudito\",\n        \"Mercen\\xe1rio\"\n    ],\n    \"D&D 5e\": [\n        \"B\\xe1rbaro\",\n        \"Bardo\",\n        \"Bruxo\",\n        \"Cl\\xe9rigo\",\n        \"Druida\",\n        \"Feiticeiro\",\n        \"Guerreiro\",\n        \"Ladino\",\n        \"Mago\",\n        \"Monge\",\n        \"Paladino\",\n        \"Patrulheiro\",\n        \"Art\\xedfice\"\n    ],\n    \"Ordem Paranormal\": [\n        \"Combatente\",\n        \"Ocultista\",\n        \"Especialista\",\n        \"Sobrevivente\"\n    ],\n    \"Call of Cthulhu\": [\n        \"Investigador\",\n        \"Antrop\\xf3logo\",\n        \"Arque\\xf3logo\",\n        \"Artista\",\n        \"Detetive\",\n        \"Jornalista\",\n        \"M\\xe9dico\",\n        \"Professor\",\n        \"Criminoso\",\n        \"Diletante\",\n        \"Engenheiro\",\n        \"Explorador\",\n        \"Historiador\",\n        \"Linguista\",\n        \"Militar\",\n        \"Policial\",\n        \"Psic\\xf3logo\",\n        \"Rep\\xf3rter\",\n        \"Pesquisador\"\n    ]\n};\nconst INITIAL_SYSTEM_PROMPT_TEMPLATE = `\n# PROTOCOLO MESTRE SUPREMO (v2.0 - Strict Rules)\n## 1. Persona e Misso\nVoc  o Mestre Supremo (Game Master), narrador experiente.\nIdioma: SEMPRE Portugus do Brasil.\nObjetivo: Guiar uma aventura imersiva com mecnicas slidas.\n\n## 2. CONTEXTO\n**Mundo:** {{WORLD_HISTORY}}\n**Personagem:** {{CHAR_NAME}}, {{CHAR_APPEARANCE}}.\n**Background:** {{CHAR_BACKSTORY}}\n**Sistema:** {{SYSTEM_NAME}}\n**Regras:** {{SYSTEM_RULES}}\n\n## 3. Gesto de Estado & REGRAS DE DADOS (CRTICO)\n- **REGRA DE OURO DAS ROLAGENS:** NO assuma o sucesso ou fracasso de aes incertas.\n- **INICIATIVA SEM ROLAGEM:** A iniciativa  sempre determinada pelo MAIOR atributo de destreza (ou equivalente do sistema, ex: agilidade/reflexos). No pea rolagem para iniciativa.\n- Se o jogador disser \"Eu tento ouvir\", \"Eu procuro por armadilhas\", \"Eu ataco\", \"Eu minto\", \"Eu escalo\":\n  1. **PARE A NARRATIVA IMEDIATAMENTE.**\n  2. Chame a Tool \"request_roll\" com o atributo apropriado (ex: Perception, Investigation, Athletics).\n  3. S continue a narrativa aps receber o resultado.\n- Use Tool \"generate_image\" APENAS em: Incio da Aventura, Bosses, Locais picos.\n- Use Tool \"trigger_game_over\" se PV = 0 ou morte narrativa bvia.\n\n## 4. Consistncia Visual\nEstilo: \"{{VISUAL_STYLE}}\". Use este estilo nos prompts de imagem.\n\n## 5. Fluxo de Turno\n1. Se for uma resposta a uma rolagem, narre o resultado (Sucesso ou Falha) dramaticamente.\n2. Narre a reao do mundo.\n3. No final de CADA mensagem, adicione uma lista de 3 a 5 sugestes.\n   \n   Formato Obrigatrio de Sugestes:\n   ### Sugestes:\n   - A) [Ao Sugerida 1]\n   - B) [Ao Sugerida 2]\n   - C) [Ao Sugerida 3]\n\n## 6. Formatao\n- Use Markdown rico.\n- Negrito para NPCs ou Itens.\n- *Itlico* para sons e pensamentos.\n- Quebras de linha duplas para legibilidade.\n`;\n//# sourceURL=[module]\n//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiKHJzYykvLi9jb25zdGFudHMudHMiLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7O0FBQU8sTUFBTUEsY0FBc0M7SUFDakQsYUFBYSxDQUFDOzs7O0VBSWQsQ0FBQztJQUNELFVBQVUsQ0FBQzs7Ozs7RUFLWCxDQUFDO0lBQ0Qsb0JBQW9CLENBQUM7Ozs7O0VBS3JCLENBQUM7SUFDRCxtQkFBbUIsQ0FBQzs7Ozs7O0VBTXBCLENBQUM7QUFDSCxFQUFFO0FBRUssTUFBTUMsb0JBQW9CO0lBQUM7SUFBYTtJQUFVO0lBQW9CO0NBQWtCLENBQVU7QUFHbEcsU0FBU0Msb0JBQW9CQyxVQUFtQjtJQUNyRCxJQUFJQSxjQUFjRixrQkFBa0JHLFFBQVEsQ0FBQ0QsYUFBZ0M7UUFDM0UsT0FBT0E7SUFDVDtJQUNBLE9BQU87QUFDVDtBQUVPLE1BQU1FLG1CQUFzRDtJQUNqRSxhQUFhO1FBQ1g7UUFDQTtRQUNBO1FBQ0E7UUFDQTtRQUNBO1FBQ0E7UUFDQTtRQUNBO1FBQ0E7S0FDRDtJQUNELFVBQVU7UUFDUjtRQUNBO1FBQ0E7UUFDQTtRQUNBO1FBQ0E7UUFDQTtRQUNBO1FBQ0E7UUFDQTtRQUNBO1FBQ0E7UUFDQTtRQUNBO1FBQ0E7UUFDQTtRQUNBO1FBQ0E7S0FDRDtJQUNELG9CQUFvQjtRQUNsQjtRQUNBO1FBQ0E7UUFDQTtRQUNBO1FBQ0E7UUFDQTtRQUNBO1FBQ0E7UUFDQTtRQUNBO1FBQ0E7UUFDQTtRQUNBO1FBQ0E7UUFDQTtRQUNBO1FBQ0E7UUFDQTtRQUNBO1FBQ0E7UUFDQTtLQUNEO0lBQ0QsbUJBQW1CO1FBQ2pCO1FBQ0E7UUFDQTtRQUNBO1FBQ0E7UUFDQTtRQUNBO1FBQ0E7UUFDQTtRQUNBO1FBQ0E7UUFDQTtRQUNBO1FBQ0E7UUFDQTtRQUNBO1FBQ0E7UUFDQTtRQUNBO1FBQ0E7UUFDQTtRQUNBO1FBQ0E7UUFDQTtRQUNBO1FBQ0E7UUFDQTtRQUNBO1FBQ0E7UUFDQTtRQUNBO1FBQ0E7S0FDRDtBQUNILEVBQUU7QUFFSyxNQUFNQyxvQkFBdUQ7SUFDbEUsYUFBYTtRQUNYO1FBQ0E7UUFDQTtRQUNBO1FBQ0E7S0FDRDtJQUNELFVBQVU7UUFDUjtRQUNBO1FBQ0E7UUFDQTtRQUNBO1FBQ0E7UUFDQTtRQUNBO1FBQ0E7UUFDQTtRQUNBO1FBQ0E7UUFDQTtLQUNEO0lBQ0Qsb0JBQW9CO1FBQ2xCO1FBQ0E7UUFDQTtRQUNBO0tBQ0Q7SUFDRCxtQkFBbUI7UUFDakI7UUFDQTtRQUNBO1FBQ0E7UUFDQTtRQUNBO1FBQ0E7UUFDQTtRQUNBO1FBQ0E7UUFDQTtRQUNBO1FBQ0E7UUFDQTtRQUNBO1FBQ0E7UUFDQTtRQUNBO1FBQ0E7S0FDRDtBQUNILEVBQUU7QUFFSyxNQUFNQyxpQ0FBaUMsQ0FBQzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQTJDL0MsQ0FBQyxDQUFDIiwic291cmNlcyI6WyJ3ZWJwYWNrOi8vbWVzdHJhaS0tLXZpcnR1YWwtdGFibGV0b3AvLi9jb25zdGFudHMudHM/ZGQ0ZSJdLCJzb3VyY2VzQ29udGVudCI6WyJleHBvcnQgY29uc3QgUlBHX1NZU1RFTVM6IFJlY29yZDxzdHJpbmcsIHN0cmluZz4gPSB7XG4gICdOYXJyYXRpdm8nOiBgXG4gICAgLSBTaXN0ZW1hIEdlbsOpcmljbyBCYXNlYWRvIGVtIE5hcnJhdGl2YSAoRm9jbyBlbSBIaXN0w7NyaWEpLlxuICAgIC0gUm9sYWdlbnM6IGQyMCBTaW1wbGVzLiAxMCsgU3VjZXNzbywgMTUrIFN1Y2Vzc28gQm9tLCAyMCBTdWNlc3NvIENyw610aWNvLlxuICAgIC0gUHJpb3JpemUgYSByZWdyYSBkbyBsZWdhbCAoUnVsZSBvZiBDb29sKS5cbiAgYCxcbiAgJ0QmRCA1ZSc6IGBcbiAgICAtIFNpc3RlbWE6IER1bmdlb25zICYgRHJhZ29ucyA1dGggRWRpdGlvbi5cbiAgICAtIFJvbGFnZW5zOiBkMjAgKyBNb2RpZmljYWRvciB2cyBDbGFzc2UgZGUgRGlmaWN1bGRhZGUgKENEKS5cbiAgICAtIEF0cmlidXRvczogRm9yw6dhLCBEZXN0cmV6YSwgQ29uc3RpdHVpw6fDo28sIEludGVsaWfDqm5jaWEsIFNhYmVkb3JpYSwgQ2FyaXNtYS5cbiAgICAtIFJFR1JBUyBDUsONVElDQVM6IFRlc3RlcyBkZSBQZXJjZXDDp8OjbyAoU2FiZWRvcmlhKSBwYXJhIG91dmlyL25vdGFyLCBJbnZlc3RpZ2HDp8OjbyAoSW50ZWxpZ8OqbmNpYSkgcGFyYSBwcm9jdXJhciwgRnVydGl2aWRhZGUgKERlc3RyZXphKSBwYXJhIGVzY29uZGVyLlxuICBgLFxuICAnT3JkZW0gUGFyYW5vcm1hbCc6IGBcbiAgICAtIFNpc3RlbWE6IE9yZGVtIFBhcmFub3JtYWwgUlBHLlxuICAgIC0gQXRyaWJ1dG9zIHByaW5jaXBhaXM6IEZvcsOnYSwgQWdpbGlkYWRlLCBJbnRlbGVjdG8sIFByZXNlbsOnYSwgVmlnb3IuXG4gICAgLSBBw6fDtWVzIGUgdGVzdGVzIHVzYW0gZDIwICsgYXRyaWJ1dG8uXG4gICAgLSBIb3Jyb3IgSW52ZXN0aWdhdGl2by4gTyBQYXJhbm9ybWFsIG7Do28gdmVtIHBhcmEgbm9zc2EgcmVhbGlkYWRlIGRlIGZvcm1hIGbDoWNpbC5cbiAgYCxcbiAgJ0NhbGwgb2YgQ3RodWxodSc6IGBcbiAgICAtIFNpc3RlbWE6IEJhc2VhZG8gZW0gQlJQIChkMTAwKS5cbiAgICAtIEF0cmlidXRvczogRm9yw6dhLCBDb25zdGl0dWnDp8OjbywgRGVzdHJlemEsIEludGVsaWfDqm5jaWEsIFBvZGVyLCBBcGFyw6puY2lhLCBFZHVjYcOnw6NvLCBUYW1hbmhvLlxuICAgIC0gVGVzdGVzIHVzYW0gcGVyY2VudHVhaXM7IHN1Y2Vzc28gY29tIHJlc3VsdGFkbyA8PSBhdHJpYnV0by5cbiAgICAtIEZvY28gZW0gSG9ycm9yIEPDs3NtaWNvLCBJbnZlc3RpZ2HDp8OjbyBlIExvdWN1cmEuXG4gICAgLSBDb21iYXRlIMOpIG1vcnRhbCBlIGRldmUgc2VyIGV2aXRhZG8uXG4gIGAsXG59O1xuXG5leHBvcnQgY29uc3QgU1VQUE9SVEVEX1NZU1RFTVMgPSBbJ05hcnJhdGl2bycsICdEJkQgNWUnLCAnT3JkZW0gUGFyYW5vcm1hbCcsICdDYWxsIG9mIEN0aHVsaHUnXSBhcyBjb25zdDtcbmV4cG9ydCB0eXBlIFN1cHBvcnRlZFN5c3RlbSA9ICh0eXBlb2YgU1VQUE9SVEVEX1NZU1RFTVMpW251bWJlcl07XG5cbmV4cG9ydCBmdW5jdGlvbiBub3JtYWxpemVTeXN0ZW1OYW1lKHN5c3RlbU5hbWU/OiBzdHJpbmcpOiBTdXBwb3J0ZWRTeXN0ZW0ge1xuICBpZiAoc3lzdGVtTmFtZSAmJiBTVVBQT1JURURfU1lTVEVNUy5pbmNsdWRlcyhzeXN0ZW1OYW1lIGFzIFN1cHBvcnRlZFN5c3RlbSkpIHtcbiAgICByZXR1cm4gc3lzdGVtTmFtZSBhcyBTdXBwb3J0ZWRTeXN0ZW07XG4gIH1cbiAgcmV0dXJuICdOYXJyYXRpdm8nO1xufVxuXG5leHBvcnQgY29uc3QgU0tJTExTX0JZX1NZU1RFTTogUmVjb3JkPFN1cHBvcnRlZFN5c3RlbSwgc3RyaW5nW10+ID0ge1xuICAnTmFycmF0aXZvJzogW1xuICAgICdBdGxldGlzbW8nLFxuICAgICdGdXJ0aXZpZGFkZScsXG4gICAgJ1BlcmNlcMOnw6NvJyxcbiAgICAnSW52ZXN0aWdhw6fDo28nLFxuICAgICdQZXJzdWFzw6NvJyxcbiAgICAnSW50aW1pZGHDp8OjbycsXG4gICAgJ0VuZ2FuYcOnw6NvJyxcbiAgICAnU29icmV2aXbDqm5jaWEnLFxuICAgICdNZWRpY2luYScsXG4gICAgJ0NvbmhlY2ltZW50bycsXG4gIF0sXG4gICdEJkQgNWUnOiBbXG4gICAgJ0Fjcm9iYXRpY3MgKEFjcm9iYWNpYSknLFxuICAgICdBbmltYWwgSGFuZGxpbmcgKEFkZXN0cmFyIEFuaW1haXMpJyxcbiAgICAnQXJjYW5hIChBcmNhbm8pJyxcbiAgICAnQXRobGV0aWNzIChBdGxldGlzbW8pJyxcbiAgICAnRGVjZXB0aW9uIChFbmdhbmHDp8OjbyknLFxuICAgICdIaXN0b3J5IChIaXN0w7NyaWEpJyxcbiAgICAnSW5zaWdodCAoSW50dWnDp8OjbyknLFxuICAgICdJbnRpbWlkYXRpb24gKEludGltaWRhw6fDo28pJyxcbiAgICAnSW52ZXN0aWdhdGlvbiAoSW52ZXN0aWdhw6fDo28pJyxcbiAgICAnTWVkaWNpbmUgKE1lZGljaW5hKScsXG4gICAgJ05hdHVyZSAoTmF0dXJlemEpJyxcbiAgICAnUGVyY2VwdGlvbiAoUGVyY2Vww6fDo28pJyxcbiAgICAnUGVyZm9ybWFuY2UgKEF0dWHDp8OjbyknLFxuICAgICdQZXJzdWFzaW9uIChQZXJzdWFzw6NvKScsXG4gICAgJ1JlbGlnaW9uIChSZWxpZ2nDo28pJyxcbiAgICAnU2xlaWdodCBvZiBIYW5kIChQcmVzdGlkaWdpdGHDp8OjbyknLFxuICAgICdTdGVhbHRoIChGdXJ0aXZpZGFkZSknLFxuICAgICdTdXJ2aXZhbCAoU29icmV2aXbDqm5jaWEpJyxcbiAgXSxcbiAgJ09yZGVtIFBhcmFub3JtYWwnOiBbXG4gICAgJ0Fjcm9iYWNpYScsXG4gICAgJ0FkZXN0cmFtZW50bycsXG4gICAgJ0FydGVzJyxcbiAgICAnQXRsZXRpc21vJyxcbiAgICAnQXR1YWxpZGFkZXMnLFxuICAgICdFbmdhbmHDp8OjbycsXG4gICAgJ0ZvcnRpdHVkZScsXG4gICAgJ0Z1cnRpdmlkYWRlJyxcbiAgICAnSW5pY2lhdGl2YScsXG4gICAgJ0ludGltaWRhw6fDo28nLFxuICAgICdJbnZlc3RpZ2HDp8OjbycsXG4gICAgJ0ludHVpw6fDo28nLFxuICAgICdMdXRhJyxcbiAgICAnTWVkaWNpbmEnLFxuICAgICdPY3VsdGlzbW8nLFxuICAgICdQZXJjZXDDp8OjbycsXG4gICAgJ1BlcnN1YXPDo28nLFxuICAgICdQaWxvdGFnZW0nLFxuICAgICdQb250YXJpYScsXG4gICAgJ1JlZmxleG9zJyxcbiAgICAnVGVjbm9sb2dpYScsXG4gICAgJ1ZvbnRhZGUnLFxuICBdLFxuICAnQ2FsbCBvZiBDdGh1bGh1JzogW1xuICAgICdBY2NvdW50aW5nIChDb250YWJpbGlkYWRlKScsXG4gICAgJ0FudGhyb3BvbG9neSAoQW50cm9wb2xvZ2lhKScsXG4gICAgJ0FyY2hhZW9sb2d5IChBcnF1ZW9sb2dpYSknLFxuICAgICdBcnQvQ3JhZnQgKEFydGUvT2bDrWNpbyknLFxuICAgICdDaGFybSAoTMOhYmlhKScsXG4gICAgJ0NsaW1iIChFc2NhbGFyKScsXG4gICAgJ0NyZWRpdCBSYXRpbmcgKENyw6lkaXRvKScsXG4gICAgJ0Rpc2d1aXNlIChEaXNmYXJjZSknLFxuICAgICdEb2RnZSAoRXNxdWl2YSknLFxuICAgICdEcml2ZSBBdXRvIChEaXJpZ2lyKScsXG4gICAgJ0Zhc3QgVGFsayAoTMOhYmlhIFLDoXBpZGEpJyxcbiAgICAnRmlyc3QgQWlkIChQcmltZWlyb3MgU29jb3Jyb3MpJyxcbiAgICAnSGlzdG9yeSAoSGlzdMOzcmlhKScsXG4gICAgJ0ludGltaWRhdGUgKEludGltaWRhw6fDo28pJyxcbiAgICAnSnVtcCAoU2FsdGFyKScsXG4gICAgJ0xhdyAoRGlyZWl0byknLFxuICAgICdMaWJyYXJ5IFVzZSAoQmlibGlvdGVjYSknLFxuICAgICdMaXN0ZW4gKEVzY3V0YXIpJyxcbiAgICAnTG9ja3NtaXRoIChBcnJvbWJhbWVudG8pJyxcbiAgICAnTWVkaWNpbmUgKE1lZGljaW5hKScsXG4gICAgJ05hdHVyYWwgV29ybGQgKE11bmRvIE5hdHVyYWwpJyxcbiAgICAnT2NjdWx0IChPY3VsdGlzbW8pJyxcbiAgICAnT3BlcmF0ZSBIZWF2eSBNYWNoaW5lcnkgKE3DoXF1aW5hcyBQZXNhZGFzKScsXG4gICAgJ1BlcnN1YWRlIChQZXJzdWFzw6NvKScsXG4gICAgJ1BzeWNob2xvZ3kgKFBzaWNvbG9naWEpJyxcbiAgICAnU2NpZW5jZSAoQ2nDqm5jaWEpJyxcbiAgICAnU3BvdCBIaWRkZW4gKE5vdGFyKScsXG4gICAgJ1N0ZWFsdGggKEZ1cnRpdmlkYWRlKScsXG4gICAgJ1N1cnZpdmFsIChTb2JyZXZpdsOqbmNpYSknLFxuICAgICdTd2ltIChOYXRhw6fDo28pJyxcbiAgICAnVGhyb3cgKEFycmVtZXNzbyknLFxuICAgICdUcmFjayAoUmFzdHJlYXIpJyxcbiAgXSxcbn07XG5cbmV4cG9ydCBjb25zdCBDTEFTU0VTX0JZX1NZU1RFTTogUmVjb3JkPFN1cHBvcnRlZFN5c3RlbSwgc3RyaW5nW10+ID0ge1xuICAnTmFycmF0aXZvJzogW1xuICAgICdBdmVudHVyZWlybycsXG4gICAgJ0V4cGxvcmFkb3InLFxuICAgICdTb2JyZXZpdmVudGUnLFxuICAgICdFcnVkaXRvJyxcbiAgICAnTWVyY2Vuw6FyaW8nLFxuICBdLFxuICAnRCZEIDVlJzogW1xuICAgICdCw6FyYmFybycsXG4gICAgJ0JhcmRvJyxcbiAgICAnQnJ1eG8nLFxuICAgICdDbMOpcmlnbycsXG4gICAgJ0RydWlkYScsXG4gICAgJ0ZlaXRpY2Vpcm8nLFxuICAgICdHdWVycmVpcm8nLFxuICAgICdMYWRpbm8nLFxuICAgICdNYWdvJyxcbiAgICAnTW9uZ2UnLFxuICAgICdQYWxhZGlubycsXG4gICAgJ1BhdHJ1bGhlaXJvJyxcbiAgICAnQXJ0w61maWNlJyxcbiAgXSxcbiAgJ09yZGVtIFBhcmFub3JtYWwnOiBbXG4gICAgJ0NvbWJhdGVudGUnLFxuICAgICdPY3VsdGlzdGEnLFxuICAgICdFc3BlY2lhbGlzdGEnLFxuICAgICdTb2JyZXZpdmVudGUnLFxuICBdLFxuICAnQ2FsbCBvZiBDdGh1bGh1JzogW1xuICAgICdJbnZlc3RpZ2Fkb3InLFxuICAgICdBbnRyb3DDs2xvZ28nLFxuICAgICdBcnF1ZcOzbG9nbycsXG4gICAgJ0FydGlzdGEnLFxuICAgICdEZXRldGl2ZScsXG4gICAgJ0pvcm5hbGlzdGEnLFxuICAgICdNw6lkaWNvJyxcbiAgICAnUHJvZmVzc29yJyxcbiAgICAnQ3JpbWlub3NvJyxcbiAgICAnRGlsZXRhbnRlJyxcbiAgICAnRW5nZW5oZWlybycsXG4gICAgJ0V4cGxvcmFkb3InLFxuICAgICdIaXN0b3JpYWRvcicsXG4gICAgJ0xpbmd1aXN0YScsXG4gICAgJ01pbGl0YXInLFxuICAgICdQb2xpY2lhbCcsXG4gICAgJ1BzaWPDs2xvZ28nLFxuICAgICdSZXDDs3J0ZXInLFxuICAgICdQZXNxdWlzYWRvcicsXG4gIF0sXG59O1xuXG5leHBvcnQgY29uc3QgSU5JVElBTF9TWVNURU1fUFJPTVBUX1RFTVBMQVRFID0gYFxuIyBQUk9UT0NPTE8gTUVTVFJFIFNVUFJFTU8gKHYyLjAgLSBTdHJpY3QgUnVsZXMpXG4jIyAxLiBQZXJzb25hIGUgTWlzc8Ojb1xuVm9jw6ogw6kgbyBNZXN0cmUgU3VwcmVtbyAoR2FtZSBNYXN0ZXIpLCBuYXJyYWRvciBleHBlcmllbnRlLlxuSWRpb21hOiBTRU1QUkUgUG9ydHVndcOqcyBkbyBCcmFzaWwuXG5PYmpldGl2bzogR3VpYXIgdW1hIGF2ZW50dXJhIGltZXJzaXZhIGNvbSBtZWPDom5pY2FzIHPDs2xpZGFzLlxuXG4jIyAyLiBDT05URVhUT1xuKipNdW5kbzoqKiB7e1dPUkxEX0hJU1RPUll9fVxuKipQZXJzb25hZ2VtOioqIHt7Q0hBUl9OQU1FfX0sIHt7Q0hBUl9BUFBFQVJBTkNFfX0uXG4qKkJhY2tncm91bmQ6Kioge3tDSEFSX0JBQ0tTVE9SWX19XG4qKlNpc3RlbWE6Kioge3tTWVNURU1fTkFNRX19XG4qKlJlZ3JhczoqKiB7e1NZU1RFTV9SVUxFU319XG5cbiMjIDMuIEdlc3TDo28gZGUgRXN0YWRvICYgUkVHUkFTIERFIERBRE9TIChDUsONVElDTylcbi0gKipSRUdSQSBERSBPVVJPIERBUyBST0xBR0VOUzoqKiBOw4NPIGFzc3VtYSBvIHN1Y2Vzc28gb3UgZnJhY2Fzc28gZGUgYcOnw7VlcyBpbmNlcnRhcy5cbi0gKipJTklDSUFUSVZBIFNFTSBST0xBR0VNOioqIEEgaW5pY2lhdGl2YSDDqSBzZW1wcmUgZGV0ZXJtaW5hZGEgcGVsbyBNQUlPUiBhdHJpYnV0byBkZSBkZXN0cmV6YSAob3UgZXF1aXZhbGVudGUgZG8gc2lzdGVtYSwgZXg6IGFnaWxpZGFkZS9yZWZsZXhvcykuIE7Do28gcGXDp2Egcm9sYWdlbSBwYXJhIGluaWNpYXRpdmEuXG4tIFNlIG8gam9nYWRvciBkaXNzZXIgXCJFdSB0ZW50byBvdXZpclwiLCBcIkV1IHByb2N1cm8gcG9yIGFybWFkaWxoYXNcIiwgXCJFdSBhdGFjb1wiLCBcIkV1IG1pbnRvXCIsIFwiRXUgZXNjYWxvXCI6XG4gIDEuICoqUEFSRSBBIE5BUlJBVElWQSBJTUVESUFUQU1FTlRFLioqXG4gIDIuIENoYW1lIGEgVG9vbCBcInJlcXVlc3Rfcm9sbFwiIGNvbSBvIGF0cmlidXRvIGFwcm9wcmlhZG8gKGV4OiBQZXJjZXB0aW9uLCBJbnZlc3RpZ2F0aW9uLCBBdGhsZXRpY3MpLlxuICAzLiBTw7MgY29udGludWUgYSBuYXJyYXRpdmEgYXDDs3MgcmVjZWJlciBvIHJlc3VsdGFkby5cbi0gVXNlIFRvb2wgXCJnZW5lcmF0ZV9pbWFnZVwiIEFQRU5BUyBlbTogSW7DrWNpbyBkYSBBdmVudHVyYSwgQm9zc2VzLCBMb2NhaXMgw4lwaWNvcy5cbi0gVXNlIFRvb2wgXCJ0cmlnZ2VyX2dhbWVfb3ZlclwiIHNlIFBWID0gMCBvdSBtb3J0ZSBuYXJyYXRpdmEgw7NidmlhLlxuXG4jIyA0LiBDb25zaXN0w6puY2lhIFZpc3VhbFxuRXN0aWxvOiBcInt7VklTVUFMX1NUWUxFfX1cIi4gVXNlIGVzdGUgZXN0aWxvIG5vcyBwcm9tcHRzIGRlIGltYWdlbS5cblxuIyMgNS4gRmx1eG8gZGUgVHVybm9cbjEuIFNlIGZvciB1bWEgcmVzcG9zdGEgYSB1bWEgcm9sYWdlbSwgbmFycmUgbyByZXN1bHRhZG8gKFN1Y2Vzc28gb3UgRmFsaGEpIGRyYW1hdGljYW1lbnRlLlxuMi4gTmFycmUgYSByZWHDp8OjbyBkbyBtdW5kby5cbjMuIE5vIGZpbmFsIGRlIENBREEgbWVuc2FnZW0sIGFkaWNpb25lIHVtYSBsaXN0YSBkZSAzIGEgNSBzdWdlc3TDtWVzLlxuICAgXG4gICBGb3JtYXRvIE9icmlnYXTDs3JpbyBkZSBTdWdlc3TDtWVzOlxuICAgIyMjIFN1Z2VzdMO1ZXM6XG4gICAtIEEpIFtBw6fDo28gU3VnZXJpZGEgMV1cbiAgIC0gQikgW0HDp8OjbyBTdWdlcmlkYSAyXVxuICAgLSBDKSBbQcOnw6NvIFN1Z2VyaWRhIDNdXG5cbiMjIDYuIEZvcm1hdGHDp8Ojb1xuLSBVc2UgTWFya2Rvd24gcmljby5cbi0gTmVncml0byBwYXJhIE5QQ3Mgb3UgSXRlbnMuXG4tICpJdMOhbGljbyogcGFyYSBzb25zIGUgcGVuc2FtZW50b3MuXG4tIFF1ZWJyYXMgZGUgbGluaGEgZHVwbGFzIHBhcmEgbGVnaWJpbGlkYWRlLlxuYDsiXSwibmFtZXMiOlsiUlBHX1NZU1RFTVMiLCJTVVBQT1JURURfU1lTVEVNUyIsIm5vcm1hbGl6ZVN5c3RlbU5hbWUiLCJzeXN0ZW1OYW1lIiwiaW5jbHVkZXMiLCJTS0lMTFNfQllfU1lTVEVNIiwiQ0xBU1NFU19CWV9TWVNURU0iLCJJTklUSUFMX1NZU1RFTV9QUk9NUFRfVEVNUExBVEUiXSwic291cmNlUm9vdCI6IiJ9\n//# sourceURL=webpack-internal:///(rsc)/./constants.ts\n");

/***/ }),

/***/ "(rsc)/./lib/ai/keyPool.ts":
/*!***************************!*\
  !*** ./lib/ai/keyPool.ts ***!
  \***************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

eval("__webpack_require__.r(__webpack_exports__);\n/* harmony export */ __webpack_require__.d(__webpack_exports__, {\n/* harmony export */   pickApiKey: () => (/* binding */ pickApiKey)\n/* harmony export */ });\nfunction pickApiKey(userKey) {\n    if (userKey && userKey.trim().length > 0) return userKey.trim();\n    throw new Error(\"Missing BYOK header\");\n}\n//# sourceURL=[module]\n//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiKHJzYykvLi9saWIvYWkva2V5UG9vbC50cyIsIm1hcHBpbmdzIjoiOzs7O0FBQU8sU0FBU0EsV0FBV0MsT0FBZ0I7SUFDekMsSUFBSUEsV0FBV0EsUUFBUUMsSUFBSSxHQUFHQyxNQUFNLEdBQUcsR0FBRyxPQUFPRixRQUFRQyxJQUFJO0lBQzdELE1BQU0sSUFBSUUsTUFBTTtBQUNsQiIsInNvdXJjZXMiOlsid2VicGFjazovL21lc3RyYWktLS12aXJ0dWFsLXRhYmxldG9wLy4vbGliL2FpL2tleVBvb2wudHM/NjQ0MCJdLCJzb3VyY2VzQ29udGVudCI6WyJleHBvcnQgZnVuY3Rpb24gcGlja0FwaUtleSh1c2VyS2V5Pzogc3RyaW5nKTogc3RyaW5nIHtcbiAgaWYgKHVzZXJLZXkgJiYgdXNlcktleS50cmltKCkubGVuZ3RoID4gMCkgcmV0dXJuIHVzZXJLZXkudHJpbSgpO1xuICB0aHJvdyBuZXcgRXJyb3IoJ01pc3NpbmcgQllPSyBoZWFkZXInKTtcbn1cbiJdLCJuYW1lcyI6WyJwaWNrQXBpS2V5IiwidXNlcktleSIsInRyaW0iLCJsZW5ndGgiLCJFcnJvciJdLCJzb3VyY2VSb290IjoiIn0=\n//# sourceURL=webpack-internal:///(rsc)/./lib/ai/keyPool.ts\n");

/***/ }),

/***/ "(rsc)/./lib/ai/modelPool.ts":
/*!*****************************!*\
  !*** ./lib/ai/modelPool.ts ***!
  \*****************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

eval("__webpack_require__.r(__webpack_exports__);\n/* harmony export */ __webpack_require__.d(__webpack_exports__, {\n/* harmony export */   MODELS: () => (/* binding */ MODELS),\n/* harmony export */   withModelFallback: () => (/* binding */ withModelFallback)\n/* harmony export */ });\nconst MODELS = [\n    // TENTATIVA 1: O Melhor (Llama 3.3 70B)\n    \"llama-3.3-70b-versatile\",\n    // TENTATIVA 2: O Lgico (Qwen 2.5 72B) - Caso o Llama esteja com fila\n    \"qwen-2.5-72b-instruct\",\n    // TENTATIVA 3: O \"Tanque de Guerra\" (Llama 3.1 8B) - Caso voc estoure o limite dirio\n    \"llama-3.1-8b-instant\"\n];\nconst delay = (ms)=>new Promise((resolve)=>setTimeout(resolve, ms));\nconst modelIndexByKey = new Map();\nfunction clampIndex(index) {\n    if (index < 0) return 0;\n    if (index >= MODELS.length) return MODELS.length - 1;\n    return index;\n}\nasync function withModelFallback(handler, options) {\n    let lastError;\n    const wait = Math.max(0, options?.minDelayMs ?? 0);\n    const startIndex = options?.key ? clampIndex(modelIndexByKey.get(options.key) ?? 0) : 0;\n    for(let i = startIndex; i < MODELS.length; i += 1){\n        const model = MODELS[i];\n        try {\n            if (wait > 0 && i > startIndex) {\n                await delay(wait * (i - startIndex));\n            }\n            const result = await handler(model);\n            if (options?.key) {\n                modelIndexByKey.set(options.key, i);\n            }\n            return result;\n        } catch (error) {\n            const status = error?.status || error?.code;\n            if (status === 429) {\n                throw error;\n            }\n            lastError = error;\n        }\n    }\n    if (options?.key) {\n        modelIndexByKey.set(options.key, 0);\n    }\n    throw lastError ?? new Error(\"All models failed\");\n}\n//# sourceURL=[module]\n//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiKHJzYykvLi9saWIvYWkvbW9kZWxQb29sLnRzIiwibWFwcGluZ3MiOiI7Ozs7O0FBQU8sTUFBTUEsU0FBUztJQUNwQix3Q0FBd0M7SUFDeEM7SUFFQSxzRUFBc0U7SUFDdEU7SUFFQSx1RkFBdUY7SUFDdkY7Q0FDRCxDQUFDO0FBRUYsTUFBTUMsUUFBUSxDQUFDQyxLQUFlLElBQUlDLFFBQVEsQ0FBQ0MsVUFBWUMsV0FBV0QsU0FBU0Y7QUFFM0UsTUFBTUksa0JBQWtCLElBQUlDO0FBRTVCLFNBQVNDLFdBQVdDLEtBQWE7SUFDL0IsSUFBSUEsUUFBUSxHQUFHLE9BQU87SUFDdEIsSUFBSUEsU0FBU1QsT0FBT1UsTUFBTSxFQUFFLE9BQU9WLE9BQU9VLE1BQU0sR0FBRztJQUNuRCxPQUFPRDtBQUNUO0FBRU8sZUFBZUUsa0JBQ3BCQyxPQUFzQyxFQUN0Q0MsT0FBK0M7SUFFL0MsSUFBSUM7SUFDSixNQUFNQyxPQUFPQyxLQUFLQyxHQUFHLENBQUMsR0FBR0osU0FBU0ssY0FBYztJQUNoRCxNQUFNQyxhQUFhTixTQUFTTyxNQUN4QlosV0FBV0YsZ0JBQWdCZSxHQUFHLENBQUNSLFFBQVFPLEdBQUcsS0FBSyxLQUMvQztJQUVKLElBQUssSUFBSUUsSUFBSUgsWUFBWUcsSUFBSXRCLE9BQU9VLE1BQU0sRUFBRVksS0FBSyxFQUFHO1FBQ2xELE1BQU1DLFFBQVF2QixNQUFNLENBQUNzQixFQUFFO1FBQ3ZCLElBQUk7WUFDRixJQUFJUCxPQUFPLEtBQUtPLElBQUlILFlBQVk7Z0JBQzlCLE1BQU1sQixNQUFNYyxPQUFRTyxDQUFBQSxJQUFJSCxVQUFTO1lBQ25DO1lBQ0EsTUFBTUssU0FBUyxNQUFNWixRQUFRVztZQUM3QixJQUFJVixTQUFTTyxLQUFLO2dCQUNoQmQsZ0JBQWdCbUIsR0FBRyxDQUFDWixRQUFRTyxHQUFHLEVBQUVFO1lBQ25DO1lBQ0EsT0FBT0U7UUFDVCxFQUFFLE9BQU9FLE9BQU87WUFDZCxNQUFNQyxTQUFTLE9BQWdCQSxVQUFXRCxPQUFlRTtZQUN6RCxJQUFJRCxXQUFXLEtBQUs7Z0JBQ2xCLE1BQU1EO1lBQ1I7WUFDQVosWUFBWVk7UUFDZDtJQUNGO0lBRUEsSUFBSWIsU0FBU08sS0FBSztRQUNoQmQsZ0JBQWdCbUIsR0FBRyxDQUFDWixRQUFRTyxHQUFHLEVBQUU7SUFDbkM7SUFFQSxNQUFNTixhQUFhLElBQUllLE1BQU07QUFDL0IiLCJzb3VyY2VzIjpbIndlYnBhY2s6Ly9tZXN0cmFpLS0tdmlydHVhbC10YWJsZXRvcC8uL2xpYi9haS9tb2RlbFBvb2wudHM/MTZkNiJdLCJzb3VyY2VzQ29udGVudCI6WyJleHBvcnQgY29uc3QgTU9ERUxTID0gW1xuICAvLyBURU5UQVRJVkEgMTogTyBNZWxob3IgKExsYW1hIDMuMyA3MEIpXG4gICdsbGFtYS0zLjMtNzBiLXZlcnNhdGlsZScsXG5cbiAgLy8gVEVOVEFUSVZBIDI6IE8gTMOzZ2ljbyAoUXdlbiAyLjUgNzJCKSAtIENhc28gbyBMbGFtYSBlc3RlamEgY29tIGZpbGFcbiAgJ3F3ZW4tMi41LTcyYi1pbnN0cnVjdCcsXG5cbiAgLy8gVEVOVEFUSVZBIDM6IE8gXCJUYW5xdWUgZGUgR3VlcnJhXCIgKExsYW1hIDMuMSA4QikgLSBDYXNvIHZvY8OqIGVzdG91cmUgbyBsaW1pdGUgZGnDoXJpb1xuICAnbGxhbWEtMy4xLThiLWluc3RhbnQnLFxuXTtcblxuY29uc3QgZGVsYXkgPSAobXM6IG51bWJlcikgPT4gbmV3IFByb21pc2UoKHJlc29sdmUpID0+IHNldFRpbWVvdXQocmVzb2x2ZSwgbXMpKTtcblxuY29uc3QgbW9kZWxJbmRleEJ5S2V5ID0gbmV3IE1hcDxzdHJpbmcsIG51bWJlcj4oKTtcblxuZnVuY3Rpb24gY2xhbXBJbmRleChpbmRleDogbnVtYmVyKSB7XG4gIGlmIChpbmRleCA8IDApIHJldHVybiAwO1xuICBpZiAoaW5kZXggPj0gTU9ERUxTLmxlbmd0aCkgcmV0dXJuIE1PREVMUy5sZW5ndGggLSAxO1xuICByZXR1cm4gaW5kZXg7XG59XG5cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiB3aXRoTW9kZWxGYWxsYmFjazxUPihcbiAgaGFuZGxlcjogKG1vZGVsOiBzdHJpbmcpID0+IFByb21pc2U8VD4sXG4gIG9wdGlvbnM/OiB7IG1pbkRlbGF5TXM/OiBudW1iZXI7IGtleT86IHN0cmluZyB9XG4pOiBQcm9taXNlPFQ+IHtcbiAgbGV0IGxhc3RFcnJvcjogdW5rbm93bjtcbiAgY29uc3Qgd2FpdCA9IE1hdGgubWF4KDAsIG9wdGlvbnM/Lm1pbkRlbGF5TXMgPz8gMCk7XG4gIGNvbnN0IHN0YXJ0SW5kZXggPSBvcHRpb25zPy5rZXlcbiAgICA/IGNsYW1wSW5kZXgobW9kZWxJbmRleEJ5S2V5LmdldChvcHRpb25zLmtleSkgPz8gMClcbiAgICA6IDA7XG5cbiAgZm9yIChsZXQgaSA9IHN0YXJ0SW5kZXg7IGkgPCBNT0RFTFMubGVuZ3RoOyBpICs9IDEpIHtcbiAgICBjb25zdCBtb2RlbCA9IE1PREVMU1tpXTtcbiAgICB0cnkge1xuICAgICAgaWYgKHdhaXQgPiAwICYmIGkgPiBzdGFydEluZGV4KSB7XG4gICAgICAgIGF3YWl0IGRlbGF5KHdhaXQgKiAoaSAtIHN0YXJ0SW5kZXgpKTtcbiAgICAgIH1cbiAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IGhhbmRsZXIobW9kZWwpO1xuICAgICAgaWYgKG9wdGlvbnM/LmtleSkge1xuICAgICAgICBtb2RlbEluZGV4QnlLZXkuc2V0KG9wdGlvbnMua2V5LCBpKTtcbiAgICAgIH1cbiAgICAgIHJldHVybiByZXN1bHQ7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIGNvbnN0IHN0YXR1cyA9IChlcnJvciBhcyBhbnkpPy5zdGF0dXMgfHwgKGVycm9yIGFzIGFueSk/LmNvZGU7XG4gICAgICBpZiAoc3RhdHVzID09PSA0MjkpIHtcbiAgICAgICAgdGhyb3cgZXJyb3I7XG4gICAgICB9XG4gICAgICBsYXN0RXJyb3IgPSBlcnJvcjtcbiAgICB9XG4gIH1cblxuICBpZiAob3B0aW9ucz8ua2V5KSB7XG4gICAgbW9kZWxJbmRleEJ5S2V5LnNldChvcHRpb25zLmtleSwgMCk7XG4gIH1cblxuICB0aHJvdyBsYXN0RXJyb3IgPz8gbmV3IEVycm9yKCdBbGwgbW9kZWxzIGZhaWxlZCcpO1xufVxuIl0sIm5hbWVzIjpbIk1PREVMUyIsImRlbGF5IiwibXMiLCJQcm9taXNlIiwicmVzb2x2ZSIsInNldFRpbWVvdXQiLCJtb2RlbEluZGV4QnlLZXkiLCJNYXAiLCJjbGFtcEluZGV4IiwiaW5kZXgiLCJsZW5ndGgiLCJ3aXRoTW9kZWxGYWxsYmFjayIsImhhbmRsZXIiLCJvcHRpb25zIiwibGFzdEVycm9yIiwid2FpdCIsIk1hdGgiLCJtYXgiLCJtaW5EZWxheU1zIiwic3RhcnRJbmRleCIsImtleSIsImdldCIsImkiLCJtb2RlbCIsInJlc3VsdCIsInNldCIsImVycm9yIiwic3RhdHVzIiwiY29kZSIsIkVycm9yIl0sInNvdXJjZVJvb3QiOiIifQ==\n//# sourceURL=webpack-internal:///(rsc)/./lib/ai/modelPool.ts\n");

/***/ }),

/***/ "(rsc)/./lib/ai/rateLimit.ts":
/*!*****************************!*\
  !*** ./lib/ai/rateLimit.ts ***!
  \*****************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

eval("__webpack_require__.r(__webpack_exports__);\n/* harmony export */ __webpack_require__.d(__webpack_exports__, {\n/* harmony export */   isRateLimited: () => (/* binding */ isRateLimited)\n/* harmony export */ });\n/* harmony import */ var _supabase_server__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! ../supabase/server */ \"(rsc)/./lib/supabase/server.ts\");\n\nconst RATE_LIMIT_WINDOW_MS = 60000;\nconst RATE_LIMIT_WINDOW_SEC = 60;\nconst RATE_LIMIT_MAX = 20;\nconst rateLimitStore = new Map();\nfunction isRateLimitedInMemory(key) {\n    const now = Date.now();\n    const windowStart = now - RATE_LIMIT_WINDOW_MS;\n    const timestamps = rateLimitStore.get(key)?.filter((t)=>t >= windowStart) || [];\n    if (timestamps.length >= RATE_LIMIT_MAX) {\n        rateLimitStore.set(key, timestamps);\n        return true;\n    }\n    timestamps.push(now);\n    rateLimitStore.set(key, timestamps);\n    return false;\n}\nasync function isRateLimited(key) {\n    const admin = (0,_supabase_server__WEBPACK_IMPORTED_MODULE_0__.createAdminClient)();\n    if (!admin) {\n        return isRateLimitedInMemory(key);\n    }\n    const { data, error } = await admin.rpc(\"check_rate_limit\", {\n        p_key: key,\n        p_limit: RATE_LIMIT_MAX,\n        p_window_seconds: RATE_LIMIT_WINDOW_SEC\n    });\n    if (error) {\n        return isRateLimitedInMemory(key);\n    }\n    return Boolean(data);\n}\n//# sourceURL=[module]\n//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiKHJzYykvLi9saWIvYWkvcmF0ZUxpbWl0LnRzIiwibWFwcGluZ3MiOiI7Ozs7O0FBQXVEO0FBRXZELE1BQU1DLHVCQUF1QjtBQUM3QixNQUFNQyx3QkFBd0I7QUFDOUIsTUFBTUMsaUJBQWlCO0FBQ3ZCLE1BQU1DLGlCQUFpQixJQUFJQztBQUUzQixTQUFTQyxzQkFBc0JDLEdBQVc7SUFDeEMsTUFBTUMsTUFBTUMsS0FBS0QsR0FBRztJQUNwQixNQUFNRSxjQUFjRixNQUFNUDtJQUMxQixNQUFNVSxhQUFhUCxlQUFlUSxHQUFHLENBQUNMLE1BQU1NLE9BQU8sQ0FBQ0MsSUFBTUEsS0FBS0osZ0JBQWdCLEVBQUU7SUFFakYsSUFBSUMsV0FBV0ksTUFBTSxJQUFJWixnQkFBZ0I7UUFDdkNDLGVBQWVZLEdBQUcsQ0FBQ1QsS0FBS0k7UUFDeEIsT0FBTztJQUNUO0lBRUFBLFdBQVdNLElBQUksQ0FBQ1Q7SUFDaEJKLGVBQWVZLEdBQUcsQ0FBQ1QsS0FBS0k7SUFDeEIsT0FBTztBQUNUO0FBRU8sZUFBZU8sY0FBY1gsR0FBVztJQUM3QyxNQUFNWSxRQUFRbkIsbUVBQWlCQTtJQUMvQixJQUFJLENBQUNtQixPQUFPO1FBQ1YsT0FBT2Isc0JBQXNCQztJQUMvQjtJQUVBLE1BQU0sRUFBRWEsSUFBSSxFQUFFQyxLQUFLLEVBQUUsR0FBRyxNQUFNRixNQUFNRyxHQUFHLENBQUMsb0JBQW9CO1FBQzFEQyxPQUFPaEI7UUFDUGlCLFNBQVNyQjtRQUNUc0Isa0JBQWtCdkI7SUFDcEI7SUFFQSxJQUFJbUIsT0FBTztRQUNULE9BQU9mLHNCQUFzQkM7SUFDL0I7SUFFQSxPQUFPbUIsUUFBUU47QUFDakIiLCJzb3VyY2VzIjpbIndlYnBhY2s6Ly9tZXN0cmFpLS0tdmlydHVhbC10YWJsZXRvcC8uL2xpYi9haS9yYXRlTGltaXQudHM/YmI2ZiJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBjcmVhdGVBZG1pbkNsaWVudCB9IGZyb20gJy4uL3N1cGFiYXNlL3NlcnZlcic7XG5cbmNvbnN0IFJBVEVfTElNSVRfV0lORE9XX01TID0gNjBfMDAwO1xuY29uc3QgUkFURV9MSU1JVF9XSU5ET1dfU0VDID0gNjA7XG5jb25zdCBSQVRFX0xJTUlUX01BWCA9IDIwO1xuY29uc3QgcmF0ZUxpbWl0U3RvcmUgPSBuZXcgTWFwPHN0cmluZywgbnVtYmVyW10+KCk7XG5cbmZ1bmN0aW9uIGlzUmF0ZUxpbWl0ZWRJbk1lbW9yeShrZXk6IHN0cmluZyk6IGJvb2xlYW4ge1xuICBjb25zdCBub3cgPSBEYXRlLm5vdygpO1xuICBjb25zdCB3aW5kb3dTdGFydCA9IG5vdyAtIFJBVEVfTElNSVRfV0lORE9XX01TO1xuICBjb25zdCB0aW1lc3RhbXBzID0gcmF0ZUxpbWl0U3RvcmUuZ2V0KGtleSk/LmZpbHRlcigodCkgPT4gdCA+PSB3aW5kb3dTdGFydCkgfHwgW107XG5cbiAgaWYgKHRpbWVzdGFtcHMubGVuZ3RoID49IFJBVEVfTElNSVRfTUFYKSB7XG4gICAgcmF0ZUxpbWl0U3RvcmUuc2V0KGtleSwgdGltZXN0YW1wcyk7XG4gICAgcmV0dXJuIHRydWU7XG4gIH1cblxuICB0aW1lc3RhbXBzLnB1c2gobm93KTtcbiAgcmF0ZUxpbWl0U3RvcmUuc2V0KGtleSwgdGltZXN0YW1wcyk7XG4gIHJldHVybiBmYWxzZTtcbn1cblxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGlzUmF0ZUxpbWl0ZWQoa2V5OiBzdHJpbmcpOiBQcm9taXNlPGJvb2xlYW4+IHtcbiAgY29uc3QgYWRtaW4gPSBjcmVhdGVBZG1pbkNsaWVudCgpO1xuICBpZiAoIWFkbWluKSB7XG4gICAgcmV0dXJuIGlzUmF0ZUxpbWl0ZWRJbk1lbW9yeShrZXkpO1xuICB9XG5cbiAgY29uc3QgeyBkYXRhLCBlcnJvciB9ID0gYXdhaXQgYWRtaW4ucnBjKCdjaGVja19yYXRlX2xpbWl0Jywge1xuICAgIHBfa2V5OiBrZXksXG4gICAgcF9saW1pdDogUkFURV9MSU1JVF9NQVgsXG4gICAgcF93aW5kb3dfc2Vjb25kczogUkFURV9MSU1JVF9XSU5ET1dfU0VDLFxuICB9KTtcblxuICBpZiAoZXJyb3IpIHtcbiAgICByZXR1cm4gaXNSYXRlTGltaXRlZEluTWVtb3J5KGtleSk7XG4gIH1cblxuICByZXR1cm4gQm9vbGVhbihkYXRhKTtcbn0iXSwibmFtZXMiOlsiY3JlYXRlQWRtaW5DbGllbnQiLCJSQVRFX0xJTUlUX1dJTkRPV19NUyIsIlJBVEVfTElNSVRfV0lORE9XX1NFQyIsIlJBVEVfTElNSVRfTUFYIiwicmF0ZUxpbWl0U3RvcmUiLCJNYXAiLCJpc1JhdGVMaW1pdGVkSW5NZW1vcnkiLCJrZXkiLCJub3ciLCJEYXRlIiwid2luZG93U3RhcnQiLCJ0aW1lc3RhbXBzIiwiZ2V0IiwiZmlsdGVyIiwidCIsImxlbmd0aCIsInNldCIsInB1c2giLCJpc1JhdGVMaW1pdGVkIiwiYWRtaW4iLCJkYXRhIiwiZXJyb3IiLCJycGMiLCJwX2tleSIsInBfbGltaXQiLCJwX3dpbmRvd19zZWNvbmRzIiwiQm9vbGVhbiJdLCJzb3VyY2VSb290IjoiIn0=\n//# sourceURL=webpack-internal:///(rsc)/./lib/ai/rateLimit.ts\n");

/***/ }),

/***/ "(rsc)/./lib/ai/systemPrompt.ts":
/*!********************************!*\
  !*** ./lib/ai/systemPrompt.ts ***!
  \********************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

eval("__webpack_require__.r(__webpack_exports__);\n/* harmony export */ __webpack_require__.d(__webpack_exports__, {\n/* harmony export */   buildSystemPrompt: () => (/* binding */ buildSystemPrompt)\n/* harmony export */ });\n/* harmony import */ var _constants__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! ../../constants */ \"(rsc)/./constants.ts\");\n\nfunction buildSystemPrompt(campaign) {\n    const systemName = (0,_constants__WEBPACK_IMPORTED_MODULE_0__.normalizeSystemName)(campaign.systemName);\n    const rules = _constants__WEBPACK_IMPORTED_MODULE_0__.RPG_SYSTEMS[systemName] || _constants__WEBPACK_IMPORTED_MODULE_0__.RPG_SYSTEMS[\"Narrativo\"];\n    return _constants__WEBPACK_IMPORTED_MODULE_0__.INITIAL_SYSTEM_PROMPT_TEMPLATE.replace(\"{{WORLD_HISTORY}}\", campaign.worldHistory).replace(\"{{CHAR_NAME}}\", campaign.characterName).replace(\"{{CHAR_APPEARANCE}}\", campaign.characterAppearance).replace(\"{{CHAR_BACKSTORY}}\", campaign.characterBackstory).replace(\"{{SYSTEM_NAME}}\", systemName).replace(\"{{SYSTEM_RULES}}\", rules).replace(\"{{VISUAL_STYLE}}\", campaign.visualStyle).concat(`\\n\\n## 7. Estado da Mesa\\nStatus atual: ${campaign.status}.\\n- Se o status for 'waiting_for_players' ou 'paused', responda apenas com: \"[SISTEMA] Mesa em espera.\" e no avance a narrativa.\\n- A narrativa  compartilhada por todos os jogadores. NO invente fatos novos que contradigam o histrico.\\n- Personalize apenas o ponto de vista do personagem atual, mantendo a linha principal coesa.\\n`);\n}\n//# sourceURL=[module]\n//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiKHJzYykvLi9saWIvYWkvc3lzdGVtUHJvbXB0LnRzIiwibWFwcGluZ3MiOiI7Ozs7O0FBQ21HO0FBRTVGLFNBQVNHLGtCQUFrQkMsUUFBa0I7SUFDbEQsTUFBTUMsYUFBYUgsK0RBQW1CQSxDQUFDRSxTQUFTQyxVQUFVO0lBQzFELE1BQU1DLFFBQVFMLG1EQUFXLENBQUNJLFdBQVcsSUFBSUosbURBQVcsQ0FBQyxZQUFZO0lBRWpFLE9BQU9ELHNFQUE4QkEsQ0FDbENPLE9BQU8sQ0FBQyxxQkFBcUJILFNBQVNJLFlBQVksRUFDbERELE9BQU8sQ0FBQyxpQkFBaUJILFNBQVNLLGFBQWEsRUFDL0NGLE9BQU8sQ0FBQyx1QkFBdUJILFNBQVNNLG1CQUFtQixFQUMzREgsT0FBTyxDQUFDLHNCQUFzQkgsU0FBU08sa0JBQWtCLEVBQ3pESixPQUFPLENBQUMsbUJBQW1CRixZQUMzQkUsT0FBTyxDQUFDLG9CQUFvQkQsT0FDNUJDLE9BQU8sQ0FBQyxvQkFBb0JILFNBQVNRLFdBQVcsRUFDaERDLE1BQU0sQ0FBQyxDQUFDLHdDQUF3QyxFQUFFVCxTQUFTVSxNQUFNLENBQUMsOFVBQThVLENBQUM7QUFDdFoiLCJzb3VyY2VzIjpbIndlYnBhY2s6Ly9tZXN0cmFpLS0tdmlydHVhbC10YWJsZXRvcC8uL2xpYi9haS9zeXN0ZW1Qcm9tcHQudHM/MmJkYyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBDYW1wYWlnbiB9IGZyb20gJy4uLy4uL3R5cGVzJztcbmltcG9ydCB7IElOSVRJQUxfU1lTVEVNX1BST01QVF9URU1QTEFURSwgUlBHX1NZU1RFTVMsIG5vcm1hbGl6ZVN5c3RlbU5hbWUgfSBmcm9tICcuLi8uLi9jb25zdGFudHMnO1xuXG5leHBvcnQgZnVuY3Rpb24gYnVpbGRTeXN0ZW1Qcm9tcHQoY2FtcGFpZ246IENhbXBhaWduKTogc3RyaW5nIHtcbiAgY29uc3Qgc3lzdGVtTmFtZSA9IG5vcm1hbGl6ZVN5c3RlbU5hbWUoY2FtcGFpZ24uc3lzdGVtTmFtZSk7XG4gIGNvbnN0IHJ1bGVzID0gUlBHX1NZU1RFTVNbc3lzdGVtTmFtZV0gfHwgUlBHX1NZU1RFTVNbJ05hcnJhdGl2byddO1xuXG4gIHJldHVybiBJTklUSUFMX1NZU1RFTV9QUk9NUFRfVEVNUExBVEVcbiAgICAucmVwbGFjZSgne3tXT1JMRF9ISVNUT1JZfX0nLCBjYW1wYWlnbi53b3JsZEhpc3RvcnkpXG4gICAgLnJlcGxhY2UoJ3t7Q0hBUl9OQU1FfX0nLCBjYW1wYWlnbi5jaGFyYWN0ZXJOYW1lKVxuICAgIC5yZXBsYWNlKCd7e0NIQVJfQVBQRUFSQU5DRX19JywgY2FtcGFpZ24uY2hhcmFjdGVyQXBwZWFyYW5jZSlcbiAgICAucmVwbGFjZSgne3tDSEFSX0JBQ0tTVE9SWX19JywgY2FtcGFpZ24uY2hhcmFjdGVyQmFja3N0b3J5KVxuICAgIC5yZXBsYWNlKCd7e1NZU1RFTV9OQU1FfX0nLCBzeXN0ZW1OYW1lKVxuICAgIC5yZXBsYWNlKCd7e1NZU1RFTV9SVUxFU319JywgcnVsZXMpXG4gICAgLnJlcGxhY2UoJ3t7VklTVUFMX1NUWUxFfX0nLCBjYW1wYWlnbi52aXN1YWxTdHlsZSlcbiAgICAuY29uY2F0KGBcXG5cXG4jIyA3LiBFc3RhZG8gZGEgTWVzYVxcblN0YXR1cyBhdHVhbDogJHtjYW1wYWlnbi5zdGF0dXN9Llxcbi0gU2UgbyBzdGF0dXMgZm9yICd3YWl0aW5nX2Zvcl9wbGF5ZXJzJyBvdSAncGF1c2VkJywgcmVzcG9uZGEgYXBlbmFzIGNvbTogXCJbU0lTVEVNQV0gTWVzYSBlbSBlc3BlcmEuXCIgZSBuw6NvIGF2YW5jZSBhIG5hcnJhdGl2YS5cXG4tIEEgbmFycmF0aXZhIMOpIGNvbXBhcnRpbGhhZGEgcG9yIHRvZG9zIG9zIGpvZ2Fkb3Jlcy4gTsODTyBpbnZlbnRlIGZhdG9zIG5vdm9zIHF1ZSBjb250cmFkaWdhbSBvIGhpc3TDs3JpY28uXFxuLSBQZXJzb25hbGl6ZSBhcGVuYXMgbyBwb250byBkZSB2aXN0YSBkbyBwZXJzb25hZ2VtIGF0dWFsLCBtYW50ZW5kbyBhIGxpbmhhIHByaW5jaXBhbCBjb2VzYS5cXG5gKTtcbn1cbiJdLCJuYW1lcyI6WyJJTklUSUFMX1NZU1RFTV9QUk9NUFRfVEVNUExBVEUiLCJSUEdfU1lTVEVNUyIsIm5vcm1hbGl6ZVN5c3RlbU5hbWUiLCJidWlsZFN5c3RlbVByb21wdCIsImNhbXBhaWduIiwic3lzdGVtTmFtZSIsInJ1bGVzIiwicmVwbGFjZSIsIndvcmxkSGlzdG9yeSIsImNoYXJhY3Rlck5hbWUiLCJjaGFyYWN0ZXJBcHBlYXJhbmNlIiwiY2hhcmFjdGVyQmFja3N0b3J5IiwidmlzdWFsU3R5bGUiLCJjb25jYXQiLCJzdGF0dXMiXSwic291cmNlUm9vdCI6IiJ9\n//# sourceURL=webpack-internal:///(rsc)/./lib/ai/systemPrompt.ts\n");

/***/ }),

/***/ "(rsc)/./lib/supabase/server.ts":
/*!********************************!*\
  !*** ./lib/supabase/server.ts ***!
  \********************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

eval("__webpack_require__.r(__webpack_exports__);\n/* harmony export */ __webpack_require__.d(__webpack_exports__, {\n/* harmony export */   createAdminClient: () => (/* binding */ createAdminClient),\n/* harmony export */   createServerClient: () => (/* binding */ createServerClient)\n/* harmony export */ });\n/* harmony import */ var _supabase_supabase_js__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! @supabase/supabase-js */ \"(rsc)/./node_modules/@supabase/supabase-js/dist/module/index.js\");\n\nconst SUPABASE_URL = \"https://uhfqpdcylnhqmbhqzfqp.supabase.co\";\nconst SUPABASE_ANON_KEY = \"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVoZnFwZGN5bG5ocW1iaHF6ZnFwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAwNTg0OTcsImV4cCI6MjA4NTYzNDQ5N30.bsnJbhS4hS8JNxU4JIyIX4AWpm-rrmmK2KAWaPgGzm0\";\nconst SUPABASE_SERVICE_ROLE_KEY = process.env.SUPABASE_SERVICE_ROLE_KEY;\nif (!SUPABASE_URL || !SUPABASE_ANON_KEY) {\n    throw new Error(\"Missing Supabase env vars\");\n}\nfunction createServerClient(accessToken) {\n    return (0,_supabase_supabase_js__WEBPACK_IMPORTED_MODULE_0__.createClient)(SUPABASE_URL, SUPABASE_ANON_KEY, {\n        global: {\n            headers: accessToken ? {\n                Authorization: `Bearer ${accessToken}`\n            } : {}\n        }\n    });\n}\nfunction createAdminClient() {\n    if (!SUPABASE_SERVICE_ROLE_KEY) return null;\n    return (0,_supabase_supabase_js__WEBPACK_IMPORTED_MODULE_0__.createClient)(SUPABASE_URL, SUPABASE_SERVICE_ROLE_KEY, {\n        auth: {\n            persistSession: false\n        }\n    });\n}\n//# sourceURL=[module]\n//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiKHJzYykvLi9saWIvc3VwYWJhc2Uvc2VydmVyLnRzIiwibWFwcGluZ3MiOiI7Ozs7OztBQUFxRDtBQUVyRCxNQUFNQyxlQUFlQywwQ0FBb0M7QUFDekQsTUFBTUcsb0JBQW9CSCxrTkFBeUM7QUFDbkUsTUFBTUssNEJBQTRCTCxRQUFRQyxHQUFHLENBQUNJLHlCQUF5QjtBQUV2RSxJQUFJLENBQUNOLGdCQUFnQixDQUFDSSxtQkFBbUI7SUFDdkMsTUFBTSxJQUFJRyxNQUFNO0FBQ2xCO0FBRU8sU0FBU0MsbUJBQW1CQyxXQUFvQjtJQUNyRCxPQUFPVixtRUFBWUEsQ0FBQ0MsY0FBY0ksbUJBQW1CO1FBQ25ETSxRQUFRO1lBQ05DLFNBQVNGLGNBQWM7Z0JBQUVHLGVBQWUsQ0FBQyxPQUFPLEVBQUVILFlBQVksQ0FBQztZQUFDLElBQUksQ0FBQztRQUN2RTtJQUNGO0FBQ0Y7QUFFTyxTQUFTSTtJQUNkLElBQUksQ0FBQ1AsMkJBQTJCLE9BQU87SUFDdkMsT0FBT1AsbUVBQVlBLENBQUNDLGNBQWNNLDJCQUEyQjtRQUMzRFEsTUFBTTtZQUFFQyxnQkFBZ0I7UUFBTTtJQUNoQztBQUNGIiwic291cmNlcyI6WyJ3ZWJwYWNrOi8vbWVzdHJhaS0tLXZpcnR1YWwtdGFibGV0b3AvLi9saWIvc3VwYWJhc2Uvc2VydmVyLnRzPzY2MjUiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgY3JlYXRlQ2xpZW50IH0gZnJvbSAnQHN1cGFiYXNlL3N1cGFiYXNlLWpzJztcblxuY29uc3QgU1VQQUJBU0VfVVJMID0gcHJvY2Vzcy5lbnYuTkVYVF9QVUJMSUNfU1VQQUJBU0VfVVJMIGFzIHN0cmluZztcbmNvbnN0IFNVUEFCQVNFX0FOT05fS0VZID0gcHJvY2Vzcy5lbnYuTkVYVF9QVUJMSUNfU1VQQUJBU0VfQU5PTl9LRVkgYXMgc3RyaW5nO1xuY29uc3QgU1VQQUJBU0VfU0VSVklDRV9ST0xFX0tFWSA9IHByb2Nlc3MuZW52LlNVUEFCQVNFX1NFUlZJQ0VfUk9MRV9LRVkgYXMgc3RyaW5nIHwgdW5kZWZpbmVkO1xuXG5pZiAoIVNVUEFCQVNFX1VSTCB8fCAhU1VQQUJBU0VfQU5PTl9LRVkpIHtcbiAgdGhyb3cgbmV3IEVycm9yKCdNaXNzaW5nIFN1cGFiYXNlIGVudiB2YXJzJyk7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBjcmVhdGVTZXJ2ZXJDbGllbnQoYWNjZXNzVG9rZW4/OiBzdHJpbmcpIHtcbiAgcmV0dXJuIGNyZWF0ZUNsaWVudChTVVBBQkFTRV9VUkwsIFNVUEFCQVNFX0FOT05fS0VZLCB7XG4gICAgZ2xvYmFsOiB7XG4gICAgICBoZWFkZXJzOiBhY2Nlc3NUb2tlbiA/IHsgQXV0aG9yaXphdGlvbjogYEJlYXJlciAke2FjY2Vzc1Rva2VufWAgfSA6IHt9LFxuICAgIH0sXG4gIH0pO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gY3JlYXRlQWRtaW5DbGllbnQoKSB7XG4gIGlmICghU1VQQUJBU0VfU0VSVklDRV9ST0xFX0tFWSkgcmV0dXJuIG51bGw7XG4gIHJldHVybiBjcmVhdGVDbGllbnQoU1VQQUJBU0VfVVJMLCBTVVBBQkFTRV9TRVJWSUNFX1JPTEVfS0VZLCB7XG4gICAgYXV0aDogeyBwZXJzaXN0U2Vzc2lvbjogZmFsc2UgfSxcbiAgfSk7XG59Il0sIm5hbWVzIjpbImNyZWF0ZUNsaWVudCIsIlNVUEFCQVNFX1VSTCIsInByb2Nlc3MiLCJlbnYiLCJORVhUX1BVQkxJQ19TVVBBQkFTRV9VUkwiLCJTVVBBQkFTRV9BTk9OX0tFWSIsIk5FWFRfUFVCTElDX1NVUEFCQVNFX0FOT05fS0VZIiwiU1VQQUJBU0VfU0VSVklDRV9ST0xFX0tFWSIsIkVycm9yIiwiY3JlYXRlU2VydmVyQ2xpZW50IiwiYWNjZXNzVG9rZW4iLCJnbG9iYWwiLCJoZWFkZXJzIiwiQXV0aG9yaXphdGlvbiIsImNyZWF0ZUFkbWluQ2xpZW50IiwiYXV0aCIsInBlcnNpc3RTZXNzaW9uIl0sInNvdXJjZVJvb3QiOiIifQ==\n//# sourceURL=webpack-internal:///(rsc)/./lib/supabase/server.ts\n");

/***/ }),

/***/ "(rsc)/./types.ts":
/*!******************!*\
  !*** ./types.ts ***!
  \******************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

eval("__webpack_require__.r(__webpack_exports__);\n/* harmony export */ __webpack_require__.d(__webpack_exports__, {\n/* harmony export */   CampaignStatus: () => (/* binding */ CampaignStatus),\n/* harmony export */   Role: () => (/* binding */ Role)\n/* harmony export */ });\nvar Role;\n(function(Role) {\n    Role[\"USER\"] = \"user\";\n    Role[\"MODEL\"] = \"model\";\n    Role[\"SYSTEM\"] = \"system\";\n})(Role || (Role = {}));\nvar CampaignStatus;\n(function(CampaignStatus) {\n    CampaignStatus[\"WAITING\"] = \"waiting_for_players\";\n    CampaignStatus[\"ACTIVE\"] = \"active\";\n    CampaignStatus[\"PAUSED\"] = \"paused\";\n    CampaignStatus[\"ARCHIVED\"] = \"archived\";\n})(CampaignStatus || (CampaignStatus = {}));\n//# sourceURL=[module]\n//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiKHJzYykvLi90eXBlcy50cyIsIm1hcHBpbmdzIjoiOzs7Ozs7VUFBWUE7Ozs7R0FBQUEsU0FBQUE7O1VBTUFDOzs7OztHQUFBQSxtQkFBQUEiLCJzb3VyY2VzIjpbIndlYnBhY2s6Ly9tZXN0cmFpLS0tdmlydHVhbC10YWJsZXRvcC8uL3R5cGVzLnRzPzU2NTIiXSwic291cmNlc0NvbnRlbnQiOlsiZXhwb3J0IGVudW0gUm9sZSB7XG4gIFVTRVIgPSAndXNlcicsXG4gIE1PREVMID0gJ21vZGVsJyxcbiAgU1lTVEVNID0gJ3N5c3RlbScsXG59XG5cbmV4cG9ydCBlbnVtIENhbXBhaWduU3RhdHVzIHtcbiAgV0FJVElORyA9ICd3YWl0aW5nX2Zvcl9wbGF5ZXJzJyxcbiAgQUNUSVZFID0gJ2FjdGl2ZScsXG4gIFBBVVNFRCA9ICdwYXVzZWQnLFxuICBBUkNISVZFRCA9ICdhcmNoaXZlZCcsIC8vIEZvciBkZWFkIGNhbXBhaWduc1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIFVzZXJQcm9maWxlIHtcbiAgaWQ6IHN0cmluZztcbiAgdXNlcm5hbWU6IHN0cmluZztcbiAgYXBpS2V5Pzogc3RyaW5nO1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIENhbXBhaWduIHtcbiAgaWQ6IHN0cmluZztcbiAgb3duZXJJZD86IHN0cmluZztcbiAgdGl0bGU6IHN0cmluZztcbiAgZGVzY3JpcHRpb24/OiBzdHJpbmc7XG4gIFxuICAvLyBXb3JsZCBEZXRhaWxzXG4gIHdvcmxkSGlzdG9yeTogc3RyaW5nO1xuICBnZW5yZTogc3RyaW5nO1xuICBzeXN0ZW1OYW1lOiBzdHJpbmc7XG4gIHZpc3VhbFN0eWxlOiBzdHJpbmc7XG4gIFxuICAvLyBDaGFyYWN0ZXIgRGV0YWlsc1xuICBjaGFyYWN0ZXJOYW1lOiBzdHJpbmc7XG4gIGNoYXJhY3RlckFwcGVhcmFuY2U6IHN0cmluZztcbiAgY2hhcmFjdGVyQmFja3N0b3J5OiBzdHJpbmc7XG4gIGNoYXJhY3RlclByb2Zlc3Npb24/OiBzdHJpbmc7XG4gIGNoYXJhY3RlckRhdGE/OiBSZWNvcmQ8c3RyaW5nLCBhbnk+O1xuICBhdmF0YXJVcmw/OiBzdHJpbmc7XG5cbiAgc3RhdHVzOiBDYW1wYWlnblN0YXR1cztcbiAgbWF4UGxheWVycz86IG51bWJlcjtcbiAgY3JlYXRlZEF0OiBudW1iZXI7XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgTWVzc2FnZSB7XG4gIGlkOiBzdHJpbmc7XG4gIHJvbGU6IFJvbGU7XG4gIGNvbnRlbnQ6IHN0cmluZztcbiAgdGltZXN0YW1wOiBudW1iZXI7XG4gIHR5cGU/OiAndGV4dCcgfCAnaW1hZ2UnIHwgJ3N5c3RlbScgfCAnZGVhdGhfZXZlbnQnO1xuICBtZXRhZGF0YT86IHtcbiAgICBpbWFnZVVybD86IHN0cmluZztcbiAgICByb2xsUmVzdWx0PzogbnVtYmVyO1xuICAgIHJvbGxUeXBlPzogc3RyaW5nO1xuICAgIHR5cGU/OiBzdHJpbmc7XG4gICAgYWN0aW9uPzogc3RyaW5nO1xuICAgIHR1cm5faWQ/OiBzdHJpbmc7XG4gICAgb3JkZXI/OiBzdHJpbmdbXTtcbiAgICBvcmRlcl9uYW1lcz86IHN0cmluZ1tdO1xuICAgIGN1cnJlbnRfaW5kZXg/OiBudW1iZXI7XG4gICAgcGxheWVyX2lkPzogc3RyaW5nO1xuICAgIHBsYXllcl9uYW1lPzogc3RyaW5nO1xuICAgIHRleHQ/OiBzdHJpbmc7XG4gICAgcm9sbD86IG51bWJlciB8IG51bGw7XG4gICAgcmVhc29uPzogc3RyaW5nIHwgbnVsbDtcbiAgICBkZXhfa2V5Pzogc3RyaW5nO1xuICB9O1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIERpY2VSb2xsUmVxdWVzdCB7XG4gIGF0dHJpYnV0ZTogc3RyaW5nO1xuICBkaWZmaWN1bHR5X2NsYXNzOiBudW1iZXI7XG4gIGRlc2NyaXB0aW9uOiBzdHJpbmc7XG59Il0sIm5hbWVzIjpbIlJvbGUiLCJDYW1wYWlnblN0YXR1cyJdLCJzb3VyY2VSb290IjoiIn0=\n//# sourceURL=webpack-internal:///(rsc)/./types.ts\n");

/***/ })

};
;

// load runtime
var __webpack_require__ = require("../../../webpack-runtime.js");
__webpack_require__.C(exports);
var __webpack_exec__ = (moduleId) => (__webpack_require__(__webpack_require__.s = moduleId))
var __webpack_exports__ = __webpack_require__.X(0, ["vendor-chunks/next","vendor-chunks/@supabase","vendor-chunks/tr46","vendor-chunks/whatwg-url","vendor-chunks/webidl-conversions","vendor-chunks/formdata-node","vendor-chunks/ms","vendor-chunks/groq-sdk","vendor-chunks/form-data-encoder","vendor-chunks/zod","vendor-chunks/agentkeepalive","vendor-chunks/humanize-ms","vendor-chunks/event-target-shim","vendor-chunks/abort-controller"], () => (__webpack_exec__("(rsc)/./node_modules/next/dist/build/webpack/loaders/next-app-loader.js?name=app%2Fapi%2Fchat%2Froute&page=%2Fapi%2Fchat%2Froute&appPaths=&pagePath=private-next-app-dir%2Fapi%2Fchat%2Froute.ts&appDir=%2Fhome%2Fjr%2FProjetos%2FMestrAi%2Fapp&pageExtensions=tsx&pageExtensions=ts&pageExtensions=jsx&pageExtensions=js&rootDir=%2Fhome%2Fjr%2FProjetos%2FMestrAi&isDev=true&tsconfigPath=tsconfig.json&basePath=&assetPrefix=&nextConfigOutput=&preferredRegion=&middlewareConfig=e30%3D!")));
module.exports = __webpack_exports__;

})();